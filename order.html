<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Đặt hàng - Thức Store</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <style>
    body {
      background: #f8f9fa;
      font-family: 'Segoe UI', sans-serif;
      padding: 40px 0;
    }
    .order-container {
      max-width: 900px;
      margin: auto;
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
      padding: 30px;
    }
    .order-header {
      border-bottom: 3px solid #198754;
      margin-bottom: 20px;
      padding-bottom: 10px;
    }
    .order-header h2 {
      color: #198754;
      font-weight: 600;
    }
    .table img {
      width: 60px;
      height: 80px;
      object-fit: cover;
      border-radius: 6px;
    }
    .btn-success {
      background-color: #198754;
      border: none;
    }
    .btn-success:hover {
      background-color: #146c43;
    }
  </style>
</head>
<body>

<div class="order-container">
  <div class="order-header d-flex justify-content-between align-items-center">
    <h2><i class="fas fa-shopping-cart text-success"></i> Xác nhận đơn hàng</h2>
    <a href="cart.html" class="btn btn-outline-success btn-sm">← Quay lại giỏ hàng</a>
  </div>

  <!-- Thông tin sản phẩm -->
  <h5 class="mb-3">🛒 Sản phẩm bạn đã chọn</h5>
  <div class="table-responsive">
    <table class="table table-bordered align-middle">
      <thead class="table-light">
        <tr>
          <th>Ảnh</th>
          <th>Tên sản phẩm</th>
          <th>Số lượng</th>
          <th>Đơn giá</th>
          <th>Thành tiền</th>
        </tr>
      </thead>
      <tbody id="orderBody"></tbody>
    </table>
  </div>

  <div class="text-end fw-bold mb-4">
    Tổng cộng: <span id="orderTotal" class="text-danger">0đ</span>
  </div>

  <!-- Địa chỉ giao hàng -->
  <h5 class="mb-3">📍 Thông tin giao hàng</h5>
  <div id="addressSection">
    <div class="form-check mb-3">
      <input class="form-check-input" type="radio" name="addressOption" id="defaultAddress" checked>
      <label class="form-check-label" for="defaultAddress">
        Dùng địa chỉ mặc định từ tài khoản
      </label>
    </div>

    <div class="form-check mb-3">
      <input class="form-check-input" type="radio" name="addressOption" id="newAddress">
      <label class="form-check-label" for="newAddress">
        Nhập địa chỉ giao hàng mới
      </label>
    </div>

    <div id="newAddressForm" style="display:none;">
      <div class="row g-3">
        <div class="col-md-6">
          <label class="form-label">Họ tên người nhận</label>
          <input type="text" class="form-control" id="recipientName" placeholder="Nguyễn Văn A">
        </div>
        <div class="col-md-6">
          <label class="form-label">Số điện thoại</label>
          <input type="text" class="form-control" id="recipientPhone" placeholder="0123 456 789">
        </div>
        <div class="col-12">
          <label class="form-label">Địa chỉ cụ thể</label>
          <input type="text" class="form-control" id="recipientAddress" placeholder="273 An Dương Vương, TP.HCM">
        </div>
      </div>
    </div>
  </div>

  <!-- Phương thức thanh toán -->
  <h5 class="mt-4 mb-3">💰 Hình thức thanh toán</h5>
  <select class="form-select mb-4" id="paymentMethod">
    <option value="cod">Thanh toán tiền mặt khi nhận hàng (Mặc định)</option>
    <option value="bank">Chuyển khoản ngân hàng</option>
    <option value="online">Thanh toán trực tuyến</option>
  </select>

  <!-- Nút xác nhận -->
  <div class="text-end">
    <button class="btn btn-success px-4" id="confirmOrderBtn">
      <i class="fas fa-check"></i> Xác nhận đặt hàng
    </button>
  </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const currentUser = JSON.parse(localStorage.getItem("currentUser"));
  const cart = JSON.parse(localStorage.getItem("cart") || "[]");
  const orderBody = document.getElementById("orderBody");
  const orderTotal = document.getElementById("orderTotal");

  // 🔒 Kiểm tra đăng nhập
  if (!currentUser) {
    alert("Vui lòng đăng nhập để đặt hàng!");
    window.location.href = "user/login.html";
    return;
  }

  // 🛒 Hiển thị giỏ hàng
  if (cart.length === 0) {
    orderBody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">Giỏ hàng trống</td></tr>';
    document.getElementById("confirmOrderBtn").disabled = true;
    return;
  }

  let total = 0;
  cart.forEach(item => {
    const subTotal = item.qty * item.price;
    total += subTotal;
    orderBody.innerHTML += `
      <tr>
        <td><img src="${item.img}" alt="${item.name}"></td>
        <td>${item.name}</td>
        <td>${item.qty}</td>
        <td>${item.price.toLocaleString('vi-VN')}đ</td>
        <td>${subTotal.toLocaleString('vi-VN')}đ</td>
      </tr>`;
  });
  orderTotal.textContent = total.toLocaleString("vi-VN") + "đ";

  // 📍 Toggle địa chỉ mới
  document.getElementById("newAddress").addEventListener("change", e => {
    document.getElementById("newAddressForm").style.display = e.target.checked ? "block" : "none";
  });
  document.getElementById("defaultAddress").addEventListener("change", e => {
    if (e.target.checked) document.getElementById("newAddressForm").style.display = "none";
  });

  // 🟢 Xác nhận đơn hàng
  document.getElementById("confirmOrderBtn").addEventListener("click", () => {
    const method = document.getElementById("paymentMethod").value;
    const addressOption = document.querySelector("input[name='addressOption']:checked").id;
    let shippingInfo;

    if (addressOption === "defaultAddress") {
      shippingInfo = currentUser.address || "Chưa có địa chỉ trong tài khoản";
    } else {
      const name = document.getElementById("recipientName").value.trim();
      const phone = document.getElementById("recipientPhone").value.trim();
      const addr = document.getElementById("recipientAddress").value.trim();
      if (!name || !phone || !addr) return alert("Vui lòng điền đầy đủ thông tin giao hàng!");
      shippingInfo = `${name}, ${phone}, ${addr}`;
    }

    const order = {
      user: currentUser.username,
      cart,
      total,
      payment: method,
      address: shippingInfo,
      time: new Date().toLocaleString("vi-VN")
    };

    // 🗂️ Lưu vào danh sách đơn hàng
    const orders = JSON.parse(localStorage.getItem("orders") || "[]");
    orders.push(order);
    localStorage.setItem("orders", JSON.stringify(orders));

    // 🧹 Xóa giỏ hàng
    localStorage.removeItem("cart");

    alert("Đặt hàng thành công! Cảm ơn bạn đã mua sắm tại Thức Store ❤️");
    window.location.href = "trang-chu-user.html";
  });
});
</script>

</body>
</html>
