<!DOCTYPE html>
<html lang="vi">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Thanh to√°n - Th·ª©c Store</title>
  <link href="css/bootstrap.min.css" rel="stylesheet">
  <link href="css/style.css" rel="stylesheet">
  <style>
    .hidden {
      display: none;
    }
  </style>
</head>

<body>
  <!-- Navbar -->
  <nav class="navbar navbar-light bg-light px-4">
    <a href="trang-chu-user.html" class="navbar-brand">
      <h2 class="m-0">Th·ª©c Store</h2>
    </a>
  </nav>

  <div class="container my-5">
    <h2 class="mb-4 text-center">üõçÔ∏è Thanh to√°n ƒë∆°n h√†ng</h2>

    <!-- üßæ Th√¥ng tin s·∫£n ph·∫©m -->
    <div id="checkoutContainer" class="mb-5"></div>

    <!-- üë§ Th√¥ng tin kh√°ch h√†ng -->
    <h4 class="mb-3">Th√¥ng tin kh√°ch h√†ng</h4>
    <form id="checkoutForm" class="row g-3">
      <div class="col-md-6">
        <label class="form-label">H·ªç t√™n</label>
        <input type="text" id="name" class="form-control" required disabled>
      </div>
      <div class="col-md-6">
        <label class="form-label">S·ªë ƒëi·ªán tho·∫°i</label>
        <input type="text" id="phone" class="form-control" required pattern="[0-9]{9,11}" disabled>
      </div>

      <div class="col-12">
        <div class="form-check mb-3">
          <input class="form-check-input" type="checkbox" id="editInfoToggle">
          <label class="form-check-label" for="editInfoToggle">
            Nh·∫≠p l·∫°i th√¥ng tin kh√°ch h√†ng
          </label>
        </div>
      </div>

      <!-- ƒê·ªãa ch·ªâ nh·∫≠n h√†ng -->
      <div class="col-12">
        <label class="form-label">ƒê·ªãa ch·ªâ nh·∫≠n h√†ng</label><br>
        <div class="form-check">
          <input class="form-check-input" type="radio" name="addressOption" id="savedAddress" value="saved" checked>
          <label class="form-check-label" for="savedAddress">
            D√πng ƒë·ªãa ch·ªâ m·∫∑c ƒë·ªãnh t·ª´ t√†i kho·∫£n
          </label>
        </div>
        <div class="form-check mb-3">
          <input class="form-check-input" type="radio" name="addressOption" id="newAddress" value="new">
          <label class="form-check-label" for="newAddress">
            Nh·∫≠p ƒë·ªãa ch·ªâ m·ªõi
          </label>
        </div>

        <!-- ƒê·ªãa ch·ªâ m·∫∑c ƒë·ªãnh -->
        <div id="defaultAddressBox" class="border rounded p-3 mb-3 bg-light">
          <p class="mb-0" id="defaultAddress">Kh√¥ng c√≥ ƒë·ªãa ch·ªâ</p>
        </div>

        <!-- ƒê·ªãa ch·ªâ m·ªõi -->
        <div id="newAddressBox" class="border rounded p-3 hidden">
          <div class="row g-3">
            <div class="col-md-6">
              <label class="form-label">T·ªânh/Th√†nh ph·ªë</label>
              <input type="text" id="city" class="form-control">
            </div>
            <div class="col-md-6">
              <label class="form-label">Qu·∫≠n/Huy·ªán</label>
              <input type="text" id="district" class="form-control">
            </div>
            <div class="col-md-12">
              <label class="form-label">ƒê·ªãa ch·ªâ c·ª• th·ªÉ</label>
              <input type="text" id="detailAddress" class="form-control">
            </div>
          </div>
        </div>
      </div>

      <!-- H√¨nh th·ª©c thanh to√°n -->
      <div class="col-12">
        <label class="form-label">Ph∆∞∆°ng th·ª©c thanh to√°n</label>
        <div class="form-check">
          <input class="form-check-input" type="radio" name="paymentMethod" id="cash" value="Ti·ªÅn m·∫∑t" checked>
          <label class="form-check-label" for="cash">
            Thanh to√°n khi nh·∫≠n h√†ng (COD)
          </label>
        </div>
        <div class="form-check">
          <input class="form-check-input" type="radio" name="paymentMethod" id="transfer" value="Chuy·ªÉn kho·∫£n">
          <label class="form-check-label" for="transfer">
            Chuy·ªÉn kho·∫£n ng√¢n h√†ng
          </label>
        </div>
        <div class="form-check">
          <input class="form-check-input" type="radio" name="paymentMethod" id="online" value="Thanh to√°n tr·ª±c tuy·∫øn">
          <label class="form-check-label" for="online">
            Thanh to√°n tr·ª±c tuy·∫øn (v√≠, th·∫ª)
          </label>
        </div>
      </div>

      <div class="col-12 text-end">
        <button type="submit" class="btn btn-success px-5 py-2">X√°c nh·∫≠n thanh to√°n</button>
      </div>
    </form>

    <!-- K·∫øt qu·∫£ xem l·∫°i ƒë∆°n h√†ng -->
    <div id="orderSummary" class="mt-5 hidden">
      <h4 class="mb-3 text-success">‚úÖ ƒê·∫∑t h√†ng th√†nh c√¥ng!</h4>
      <p>C·∫£m ∆°n b·∫°n ƒë√£ mua s·∫Øm t·∫°i <strong>Th·ª©c Store</strong>. D∆∞·ªõi ƒë√¢y l√† th√¥ng tin ƒë∆°n h√†ng c·ªßa b·∫°n:</p>
      <div id="summaryContent"></div>
      <div class="text-end mt-3">
        <a href="trang-chu-user.html" class="btn btn-primary">Quay v·ªÅ trang ch·ªß</a>
      </div>
    </div>
  </div>

  <script>
    // üßë‚Äçüíº L·∫•y th√¥ng tin ng∆∞·ªùi d√πng t·ª´ localStorage
    const userInfo = JSON.parse(localStorage.getItem("userInfo")) || {};

    // G√°n gi√° tr·ªã m·∫∑c ƒë·ªãnh t·ª´ user ƒë√£ ƒëƒÉng nh·∫≠p
    document.getElementById("name").value = userInfo.name || "";
    document.getElementById("phone").value = userInfo.phone || "";
    document.getElementById("defaultAddress").textContent = userInfo.address || "Ch∆∞a c√≥ ƒë·ªãa ch·ªâ m·∫∑c ƒë·ªãnh";

    const nameInput = document.getElementById("name");
    const phoneInput = document.getElementById("phone");

    // Cho ph√©p nh·∫≠p l·∫°i th√¥ng tin
    document.getElementById("editInfoToggle").addEventListener("change", (e) => {
      const isEditing = e.target.checked;
      nameInput.disabled = !isEditing;
      phoneInput.disabled = !isEditing;
    });

    // Hi·ªÉn th·ªã gi·ªè h√†ng
    const checkoutItems = JSON.parse(localStorage.getItem("checkoutItems")) || [];
    const container = document.getElementById("checkoutContainer");

    if (checkoutItems.length === 0) {
      container.innerHTML = `<div class="alert alert-warning text-center">
          Kh√¥ng c√≥ s·∫£n ph·∫©m n√†o ƒë·ªÉ thanh to√°n. 
          <a href="product.html" class="alert-link">Quay l·∫°i mua h√†ng</a>
        </div>`;
    } else {
      let total = 0;
      let html = `
        <table class="table table-bordered align-middle">
          <thead class="table-light">
            <tr>
              <th>H√¨nh ·∫£nh</th>
              <th>T√™n s·∫£n ph·∫©m</th>
              <th>Gi√°</th>
              <th>S·ªë l∆∞·ª£ng</th>
              <th>T·ªïng</th>
            </tr>
          </thead>
          <tbody>
      `;
      checkoutItems.forEach(item => {
        const sum = item.price * item.qty;
        total += sum;
        html += `
          <tr>
            <td><img src="${item.img}" width="70"></td>
            <td>${item.name}</td>
            <td>${item.price.toLocaleString("vi-VN")}ƒë</td>
            <td>${item.qty}</td>
            <td>${sum.toLocaleString("vi-VN")}ƒë</td>
          </tr>
        `;
      });
      html += `
          </tbody>
        </table>
        <div class="text-end fw-bold fs-5">T·ªïng c·ªông: 
          <span class="text-danger">${total.toLocaleString("vi-VN")}ƒë</span>
        </div>
      `;
      container.innerHTML = html;
    }

    // Ch·ªçn d·∫°ng ƒë·ªãa ch·ªâ
    const savedRadio = document.getElementById("savedAddress");
    const newRadio = document.getElementById("newAddress");
    const defaultBox = document.getElementById("defaultAddressBox");
    const newBox = document.getElementById("newAddressBox");

    savedRadio.addEventListener("change", () => {
      defaultBox.classList.remove("hidden");
      newBox.classList.add("hidden");
    });
    newRadio.addEventListener("change", () => {
      defaultBox.classList.add("hidden");
      newBox.classList.remove("hidden");
    });

    // X·ª≠ l√Ω thanh to√°n
    document.getElementById("checkoutForm").addEventListener("submit", e => {
      e.preventDefault();

      const name = document.getElementById("name").value.trim();
      const phone = document.getElementById("phone").value.trim();
      const payment = document.querySelector("input[name='paymentMethod']:checked").value;
      let address = "";

      // L·∫•y ƒë·ªãa ch·ªâ
      if (savedRadio.checked) {
        address = document.getElementById("defaultAddress").innerText;
      } else {
        const city = document.getElementById("city").value.trim();
        const district = document.getElementById("district").value.trim();
        const detail = document.getElementById("detailAddress").value.trim();
        if (!city || !district || !detail) {
          alert("Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß ƒë·ªãa ch·ªâ m·ªõi!");
          return;
        }
        address = `${detail}, ${district}, ${city}`;
      }

      const total = checkoutItems.reduce((sum, i) => sum + i.price * i.qty, 0);

      // L∆∞u ƒë∆°n h√†ng
      const order = {
        id: Date.now(),
        customer: { name, phone, address },
        payment,
        items: checkoutItems,
        total,
        date: new Date().toLocaleString("vi-VN"),
        status: "chua-xu-ly"
      };

      const orders = JSON.parse(localStorage.getItem("orders")) || [];
      orders.push(order);
      localStorage.setItem("orders", JSON.stringify(orders));

      // X√≥a gi·ªè h√†ng t·∫°m
      localStorage.removeItem("checkoutItems");

      document.getElementById("checkoutForm").classList.add("hidden");

      const summaryDiv = document.getElementById("orderSummary");
      const content = document.getElementById("summaryContent");

      content.innerHTML = `
        <p><strong>T√™n:</strong> ${name}</p>
        <p><strong>SƒêT:</strong> ${phone}</p>
        <p><strong>ƒê·ªãa ch·ªâ giao h√†ng:</strong> ${address}</p>
        <p><strong>Ph∆∞∆°ng th·ª©c thanh to√°n:</strong> ${payment}</p>
        <p><strong>T·ªïng ti·ªÅn:</strong> ${total.toLocaleString("vi-VN")}ƒë</p>
        <p><strong>Th·ªùi gian ƒë·∫∑t:</strong> ${order.date}</p>
      `;

      summaryDiv.classList.remove("hidden");
    });
  </script>
</body>

</html>
