<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Admin - Qu·∫£n l√Ω Gi√° | Th·ª©c Store</title>

  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
  <link rel="stylesheet" href="../css/admin-shared.css">

  <style>
    body { background:#f3f8f3; font-family:"Open Sans",sans-serif; }
    .content-area{ background:#fff; padding:1.5rem; border-radius:1rem; box-shadow:0 3px 8px rgba(0,0,0,0.04); min-height:65vh; }
    .card { border:none; border-radius:1rem; box-shadow:0 8px 24px rgba(0,0,0,0.05); }
    .card-header { border-bottom:1px solid #eef4ef; background:#f8fffb; border-radius:1rem 1rem 0 0 !important; }
    .table thead { background:#f5f8f6; color:#2d6a4f; font-weight:600; }
    .price-input { max-width: 160px; }
    .feedback { position: fixed; right: 24px; bottom: 24px; z-index: 9; min-width: 260px; }
    .pricing-grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(280px,1fr)); gap:1rem; }
    .price-card { border:1px solid #e3efe5; border-radius:1rem; padding:1.25rem; background:#fbfffc; display:flex; flex-direction:column; gap:1rem; min-height:230px; }
    .price-card__header { display:flex; justify-content:space-between; align-items:flex-start; gap:1rem; }
    .price-card__code { font-weight:700; color:#1b4332; font-size:1.05rem; }
    .price-card__categories { font-size:0.85rem; color:#6c757d; }
    .price-card__title { font-weight:600; color:#1d1f21; line-height:1.4; }
    .price-card__metrics { display:flex; flex-wrap:wrap; gap:1rem; }
    .price-card__metric { flex:1; min-width:120px; background:#f6faf7; border-radius:0.75rem; padding:0.75rem; }
    .price-card__metric span { display:block; font-size:0.8rem; color:#6b7570; margin-bottom:0.25rem; text-transform:uppercase; letter-spacing:0.02em; }
    .price-card__metric strong { display:block; font-size:1.05rem; color:#1b4332; }
    .price-card__metric small { color:#6c757d; }
    .price-card__price { display:flex; flex-direction:column; gap:0.35rem; }
    .price-card__actions { display:flex; gap:0.5rem; align-items:center; }
    .price-card__actions .btn { flex:1; white-space:nowrap; }
    .pricing-empty { text-align:center; color:#7a827c; padding:2.5rem 1rem; border:2px dashed #dfe8e2; border-radius:1rem; width:100%; background:#fff; }
    @media (max-width: 576px) {
      .price-card__actions { flex-direction:column; align-items:stretch; }
      .price-card__actions .btn { width:100%; }
      .price-input { max-width:100%; }
    }
  </style>
</head>
<body>
  <div class="container-fluid py-4">
    <div class="admin-banner">
      <div class="text-center">
        <h1 class="h2 fw-bold">Th·ª©c Store Admin</h1>
        <div class="small">Qu·∫£n l√Ω gi√° b√°n ‚Äî giao di·ªán thao t√°c nhanh</div>
      </div>
    </div>

    <div class="row g-4">
      <!-- Sidebar -->
      <div class="col-lg-3 mb-4">
        <div class="sidebar">
          <h5>üìã Menu qu·∫£n l√Ω</h5>
          <a href="quanlysanpham.html" class="menu-item"><span class="emoji">üìò</span> Qu·∫£n l√Ω S·∫£n ph·∫©m</a>
          <a href="quanlydonhang.html" class="menu-item"><span class="emoji">üßæ</span> Qu·∫£n l√Ω ƒê∆°n h√†ng</a>
          <a href="user.html" class="menu-item"><span class="emoji">üë§</span> Qu·∫£n l√Ω Ng∆∞·ªùi d√πng</a>
          <a href="stock.html" class="menu-item"><span class="emoji">üì¶</span> Qu·∫£n l√Ω Kho</a>
          <a href="pricing.html" class="menu-item active"><span class="emoji">üí≤</span> Qu·∫£n l√Ω Gi√°</a>
          <a href="import.html" class="menu-item"><span class="emoji">üöö</span> Nh·∫≠p h√†ng</a>
        </div>
      </div>

      <div class="col-lg-9">
        <div class="content-area">
          <div class="d-flex flex-column flex-md-row justify-content-between gap-2 mb-4">
            <div>
              <h4 class="text-success mb-1">Thi·∫øt l·∫≠p gi√° b√°n</h4>
            </div>
            
          </div>

          <div class="card mb-4">
            <div class="card-body">
              <div class="row g-3">
                <div class="col-md-5">
                  <label class="form-label">T√¨m ki·∫øm (t√™n ho·∫∑c m√£ s·∫£n ph·∫©m)</label>
                  <input id="searchInput" class="form-control" placeholder="V√≠ d·ª•: VH001 / ƒê·∫Øc Nh√¢n T√¢m">
                </div>
                <div class="col-md-4">
                  <label class="form-label">L·ªçc theo nh√≥m</label>
                  <select id="categoryFilter" class="form-select">
                    <option value="">-- T·∫•t c·∫£ lo·∫°i --</option>
                  </select>
                </div>
                <div class="col-md-3">
                  <label class="form-label">Kho·∫£ng gi√° b√°n</label>
                  <div class="d-flex gap-2">
                    <input id="minPrice" type="number" class="form-control" placeholder="T·ª´">
                    <input id="maxPrice" type="number" class="form-control" placeholder="ƒê·∫øn">
                  </div>
                </div>
              </div>
              <div class="text-end mt-3">
                <button id="btnReset" class="btn btn-outline-secondary btn-sm">ƒê·∫∑t l·∫°i b·ªô l·ªçc</button>
              </div>
            </div>
          </div>

          <div class="card">
            <div class="card-header d-flex flex-wrap gap-2 justify-content-between align-items-center">
              <h5 class="mb-0 text-success"><i class="fa-solid fa-tags me-2"></i>Danh s√°ch s·∫£n ph·∫©m</h5>
              <span id="tableSummary" class="text-muted">0 s·∫£n ph·∫©m</span>
            </div>
            <div class="card-body">
              <div id="pricingTable" class="pricing-grid">
                <div class="pricing-empty">ƒêang t·∫£i d·ªØ li·ªáu...</div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div id="feedback" class="feedback d-none">
    <div class="alert alert-success shadow mb-0" role="alert">
      <span id="feedbackText">ƒê√£ c·∫≠p nh·∫≠t gi√°.</span>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      let state = [];
      const el = {
        search: document.getElementById('searchInput'),
        category: document.getElementById('categoryFilter'),
        minPrice: document.getElementById('minPrice'),
        maxPrice: document.getElementById('maxPrice'),
        table: document.getElementById('pricingTable'),
        summary: document.getElementById('tableSummary'),
        resetBtn: document.getElementById('btnReset'),
        downloadBtn: document.getElementById('btnDownload'),
        feedback: document.getElementById('feedback'),
        feedbackText: document.getElementById('feedbackText')
      };

      const formatCurrency = (value) =>
        Number(value || 0).toLocaleString('vi-VN', { style: 'currency', currency: 'VND' }).replace('‚Ç´', 'ƒë');

      const calcProfitPercent = (cost, price) => {
        if (!cost) return 0;
        return Math.round(((price - cost) / cost) * 1000) / 10;
      };

      const removeAccents = (str = '') =>
        str
          .toString()
          .normalize('NFD')
          .replace(/[\u0300-\u036f]/g, '')
          .replace(/ƒë/g, 'd')
          .replace(/ƒê/g, 'D');

      const normalizeText = (value) => removeAccents((value || '').toString().toLowerCase());

      const showFeedback = (msg) => {
        if (!el.feedback) return;
        el.feedbackText.textContent = msg;
        el.feedback.classList.remove('d-none');
        setTimeout(() => el.feedback.classList.add('d-none'), 2200);
      };

      const toNumber = (value) => {
        if (typeof value === 'number' && Number.isFinite(value)) return value;
        if (!value) return 0;
        const numeric = Number(value.toString().replace(/[^\d.-]/g, ''));
        return Number.isFinite(numeric) ? numeric : 0;
      };

      const parseInputNumber = (value) => {
        if (value === '' || value === null || value === undefined) return null;
        const parsed = Number(value);
        return Number.isFinite(parsed) ? parsed : null;
      };

      const sanitizeKey = (value) =>
        removeAccents(value.toString())
          .toLowerCase()
          .replace(/\s+/g, '-')
          .replace(/[^a-z0-9-_]/g, '');

      const buildKey = (product, index) => {
        if (product && product.id !== undefined && product.id !== null) return `id-${product.id}`;
        if (product && product.ma) return `code-${sanitizeKey(product.ma)}`;
        return `idx-${index}`;
      };

      const normalizeCategories = (value) => {
        if (Array.isArray(value)) return value.filter(Boolean);
        if (typeof value === 'string' && value.trim()) {
          return value
            .split(',')
            .map((item) => item.trim())
            .filter(Boolean);
        }
        return [];
      };

      const readProductsFromStorage = () => {
        try {
          const stored = JSON.parse(localStorage.getItem('products'));
          return Array.isArray(stored) ? stored : [];
        } catch (error) {
          console.warn('Kh√¥ng th·ªÉ ƒë·ªçc d·ªØ li·ªáu s·∫£n ph·∫©m:', error);
          return [];
        }
      };

      const normalizeProducts = (products) =>
        products.map((product, index) => {
          const categories = normalizeCategories(product?.loai);
          const code = (product?.ma || '').toString().trim();
          return {
            key: buildKey(product, index),
            storageIndex: index,
            code: code || `SP-${String(index + 1).padStart(3, '0')}`,
            name: product?.ten || 'Ch∆∞a c·∫≠p nh·∫≠t t√™n',
            categories: categories.length ? categories : ['Kh√°c'],
            cost: toNumber(product?.giagoc),
            price: toNumber(product?.gia)
          };
        });

      const syncState = () => {
        state = normalizeProducts(readProductsFromStorage());
      };

      const populateCategories = () => {
        if (!el.category) return;
        const existing = el.category.value;
        const cats = [...new Set(state.flatMap((p) => p.categories))];
        el.category.innerHTML = '<option value="">-- T·∫•t c·∫£ lo·∫°i --</option>';
        cats.forEach((c) => {
          const option = document.createElement('option');
          option.value = c;
          option.textContent = c;
          el.category.appendChild(option);
        });
        if (existing && cats.includes(existing)) el.category.value = existing;
      };

      const getFilters = () => ({
        search: normalizeText(el.search?.value?.trim() || ''),
        category: el.category?.value || '',
        min: parseInputNumber(el.minPrice?.value),
        max: parseInputNumber(el.maxPrice?.value)
      });

      const renderTable = () => {
        if (!el.table) return;
        populateCategories();
        const filters = getFilters();
        const rows = state.filter((p) => {
          const code = normalizeText(p.code);
          const name = normalizeText(p.name);
          const matchesSearch = !filters.search || code.includes(filters.search) || name.includes(filters.search);
          const matchesCategory = !filters.category || p.categories.includes(filters.category);
          const matchesMin = filters.min === null || p.price >= filters.min;
          const matchesMax = filters.max === null || p.price <= filters.max;
          return matchesSearch && matchesCategory && matchesMin && matchesMax;
        });

        const total = state.length;
        const summaryCount = total && rows.length !== total ? `${rows.length}/${total}` : rows.length;
        el.summary.textContent = `${summaryCount} s·∫£n ph·∫©m`;

        if (!rows.length) {
          const message = state.length
            ? 'Kh√¥ng t√¨m th·∫•y s·∫£n ph·∫©m ph√π h·ª£p.'
            : 'Ch∆∞a c√≥ d·ªØ li·ªáu. Vui l√≤ng th√™m s√°ch t·∫°i trang Qu·∫£n l√Ω S·∫£n ph·∫©m.';
          el.table.innerHTML = `<div class="pricing-empty">${message}</div>`;
          return;
        }

        el.table.innerHTML = rows
          .map((p) => {
            const profit = calcProfitPercent(p.cost, p.price);
            const profitValue = p.price - p.cost;
            const inputId = `price-${p.storageIndex}`;
            return `
              <div class="price-card">
                <div class="price-card__header">
                  <div>
                    <div class="price-card__code">${p.code}</div>
                    <div class="price-card__categories">${p.categories.join(', ')}</div>
                  </div>
                  <span class="badge bg-success-subtle text-success fw-semibold">${profit}%</span>
                </div>
                <div class="price-card__title">${p.name}</div>
                <div class="price-card__metrics">
                  <div class="price-card__metric">
                    <span>Gi√° v·ªën</span>
                    <strong>${formatCurrency(p.cost)}</strong>
                  </div>
                  <div class="price-card__metric">
                    <span>L·ª£i nhu·∫≠n ∆∞·ªõc t√≠nh</span>
                    <strong>${formatCurrency(profitValue)}</strong>
                    <small>${profit >= 0 ? '+' : ''}${profit}%</small>
                  </div>
                </div>
                <div class="price-card__price">
                  <span class="text-muted small text-uppercase">Gi√° b√°n hi·ªán t·∫°i</span>
                  <div class="price-card__actions">
                    <input
                      id="${inputId}"
                      type="number"
                      class="form-control price-input"
                      data-index="${p.storageIndex}"
                      data-key="${p.key}"
                      value="${p.price || ''}"
                      min="0"
                    >
                    <button
                      class="btn btn-success update-price"
                      data-input="${inputId}"
                      data-index="${p.storageIndex}"
                      data-key="${p.key}"
                    >
                      <i class="fa-solid fa-floppy-disk me-1"></i>L∆∞u gi√°
                    </button>
                  </div>
                </div>
              </div>
            `;
          })
          .join('');
      };

      const findProductIndex = (dataset, products) => {
        if (dataset.index !== undefined) {
          const parsed = parseInt(dataset.index, 10);
          if (!Number.isNaN(parsed) && products[parsed]) return parsed;
        }
        if (dataset.key) {
          return products.findIndex((product, idx) => buildKey(product, idx) === dataset.key);
        }
        return -1;
      };

      const handlePriceUpdate = (dataset) => {
        const input = dataset.input ? document.getElementById(dataset.input) : null;
        if (!input) {
          alert('Kh√¥ng th·ªÉ x√°c ƒë·ªãnh √¥ nh·∫≠p gi√° c·∫ßn c·∫≠p nh·∫≠t.');
          return;
        }
        const value = Number(input.value);
        if (Number.isNaN(value) || value <= 0) {
          alert('Vui l√≤ng nh·∫≠p gi√° b√°n h·ª£p l·ªá.');
          return;
        }

        const products = readProductsFromStorage();
        const targetIndex = findProductIndex(dataset, products);
        if (targetIndex === -1) {
          alert('Kh√¥ng t√¨m th·∫•y s·∫£n ph·∫©m ƒë·ªÉ c·∫≠p nh·∫≠t. Vui l√≤ng t·∫£i l·∫°i trang.');
          return;
        }

        products[targetIndex].gia = value;
        localStorage.setItem('products', JSON.stringify(products));
        syncState();
        renderTable();

        const updated = state.find((item) => item.storageIndex === targetIndex) || state.find((item) => item.key === dataset.key);
        showFeedback(`ƒê√£ c·∫≠p nh·∫≠t gi√° cho ${updated?.name || 's·∫£n ph·∫©m'}.`);
      };

      el.search?.addEventListener('input', renderTable);
      el.category?.addEventListener('change', renderTable);
      el.minPrice?.addEventListener('input', renderTable);
      el.maxPrice?.addEventListener('input', renderTable);
      el.resetBtn?.addEventListener('click', () => {
        if (el.search) el.search.value = '';
        if (el.category) el.category.value = '';
        if (el.minPrice) el.minPrice.value = '';
        if (el.maxPrice) el.maxPrice.value = '';
        renderTable();
      });

      document.addEventListener('click', (e) => {
        if (e.target.closest('.update-price')) {
          const btn = e.target.closest('.update-price');
          handlePriceUpdate(btn.dataset);
        }
      });

      el.downloadBtn?.addEventListener('click', () => {
        const data = readProductsFromStorage();
        const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'thuc-store-pricing.json';
        a.click();
        URL.revokeObjectURL(url);
      });

      window.addEventListener('storage', (event) => {
        if (event.key === 'products') {
          syncState();
          renderTable();
        }
      });

      syncState();
      renderTable();
    });
  </script>
</body>
</html>
