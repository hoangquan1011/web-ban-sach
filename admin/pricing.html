<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Admin - Qu·∫£n l√Ω Gi√° | Th·ª©c Store</title>

  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
  <link rel="stylesheet" href="../css/admin-shared.css">

  <style>
    body { background:#f3f8f3; font-family:"Open Sans",sans-serif; }
    .content-area{ background:#fff; padding:1.5rem; border-radius:1rem; box-shadow:0 3px 8px rgba(0,0,0,0.04); min-height:65vh; }
    .card { border:none; border-radius:1rem; box-shadow:0 8px 24px rgba(0,0,0,0.05); }
    .card-header { border-bottom:1px solid #eef4ef; background:#f8fffb; border-radius:1rem 1rem 0 0 !important; }
    .table thead { background:#f5f8f6; color:#2d6a4f; font-weight:600; }
    .price-input { max-width: 160px; }
    .feedback { position: fixed; right: 24px; bottom: 24px; z-index: 9; min-width: 260px; }
    .pricing-grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(280px,1fr)); gap:1rem; }
    .price-card { border:1px solid #e3efe5; border-radius:1rem; padding:1.25rem; background:#fbfffc; display:flex; flex-direction:column; gap:1rem; min-height:230px; }
    .price-card__header { display:flex; justify-content:space-between; align-items:flex-start; gap:1rem; }
    .price-card__code { font-weight:700; color:#1b4332; font-size:1.05rem; }
    .price-card__categories { font-size:0.85rem; color:#6c757d; }
    .price-card__title { font-weight:600; color:#1d1f21; line-height:1.4; }
    .price-card__metrics { display:flex; flex-wrap:wrap; gap:1rem; }
    .price-card__metric { flex:1; min-width:120px; background:#f6faf7; border-radius:0.75rem; padding:0.75rem; }
    .price-card__metric span { display:block; font-size:0.8rem; color:#6b7570; margin-bottom:0.25rem; text-transform:uppercase; letter-spacing:0.02em; }
    .price-card__metric strong { display:block; font-size:1.05rem; color:#1b4332; }
    .price-card__metric small { color:#6c757d; }
    .price-card__price { display:flex; flex-direction:column; gap:0.35rem; }
    .price-card__actions { display:flex; gap:0.5rem; align-items:center; }
    .price-card__actions .btn { flex:1; white-space:nowrap; }
    .price-card__adjust label { font-size:0.75rem; text-transform:uppercase; color:#6c757d; letter-spacing:0.03em; display:block; margin-bottom:0.25rem; }
    .pricing-empty { text-align:center; color:#7a827c; padding:2.5rem 1rem; border:2px dashed #dfe8e2; border-radius:1rem; width:100%; background:#fff; }
    @media (max-width: 576px) {
      .price-card__actions { flex-direction:column; align-items:stretch; }
      .price-card__actions .btn { width:100%; }
      .price-input { max-width:100%; }
    }
  </style>
</head>
<body>
  <div class="container-fluid py-4">
    <div class="admin-banner">
      <div class="text-center">
        <h1 class="h2 fw-bold">Th·ª©c Store Admin</h1>
        <div class="small">Qu·∫£n l√Ω gi√° b√°n ‚Äî giao di·ªán thao t√°c nhanh</div>
      </div>
    </div>

    <div class="row g-4">
      <!-- Sidebar -->
      <div class="col-lg-3 mb-4">
        <div class="sidebar">
          <h5>üìã Menu qu·∫£n l√Ω</h5>
          <a href="quanlysanpham.html" class="menu-item"><span class="emoji">üìò</span> Qu·∫£n l√Ω S·∫£n ph·∫©m</a>
          <a href="quanlydonhang.html" class="menu-item"><span class="emoji">üßæ</span> Qu·∫£n l√Ω ƒê∆°n h√†ng</a>
          <a href="user.html" class="menu-item"><span class="emoji">üë§</span> Qu·∫£n l√Ω Ng∆∞·ªùi d√πng</a>
          <a href="stock.html" class="menu-item"><span class="emoji">üì¶</span> Qu·∫£n l√Ω Kho</a>
          <a href="pricing.html" class="menu-item active"><span class="emoji">üí≤</span> Qu·∫£n l√Ω Gi√°</a>
          <a href="import.html" class="menu-item"><span class="emoji">üöö</span> Nh·∫≠p h√†ng</a>
        </div>
      </div>

      <div class="col-lg-9">
        <div class="content-area">
          <div class="d-flex flex-column flex-md-row justify-content-between gap-2 mb-4">
            <div>
              <h4 class="text-success mb-1">Thi·∫øt l·∫≠p gi√° b√°n</h4>
            </div>
            
          </div>

          <div class="card mb-4">
            <div class="card-body">
              <div class="row g-3">
                <div class="col-md-5">
                  <label class="form-label">T√¨m ki·∫øm (t√™n ho·∫∑c m√£ s·∫£n ph·∫©m)</label>
                  <input class="form-control" placeholder="V√≠ d·ª•: VH001 / ƒê·∫Øc Nh√¢n T√¢m">
                </div>
                <div class="col-md-4">
                  <label class="form-label">L·ªçc theo nh√≥m</label>
                  <select id="categoryFilter" class="form-select">
                    <option value="">-- T·∫•t c·∫£ lo·∫°i --</option>
                    <option value="Gi√°o khoa">Gi√°o khoa</option>
                    <option value="Kinh t·∫ø">Kinh t·∫ø</option>
                    <option value="K·ªπ nƒÉng s·ªëng">K·ªπ nƒÉng s·ªëng</option>
                    <option value="Thi·∫øu nhi">Thi·∫øu nhi</option>
                    <option value="VƒÉn h·ªçc">VƒÉn h·ªçc</option>
                  </select>
                </div>
                <div class="col-md-3">
                  <label class="form-label">Kho·∫£ng gi√° b√°n</label>
                  <div class="d-flex gap-2">
                    <input type="number" class="form-control" placeholder="T·ª´">
                    <input type="number" class="form-control" placeholder="ƒê·∫øn">
                  </div>
                </div>
              </div>
              <div class="text-end mt-3">
                <button class="btn btn-outline-secondary btn-sm">ƒê·∫∑t l·∫°i b·ªô l·ªçc</button>
              </div>
            </div>
          </div>

          <div class="card">
            <div class="card-header d-flex flex-wrap gap-2 justify-content-between align-items-center">
              <h5 class="mb-0 text-success"><i class="fa-solid fa-tags me-2"></i>Danh s√°ch s·∫£n ph·∫©m</h5>
              <div class="d-flex align-items-center gap-2">
                <span id="tableSummary" class="text-muted">0 s·∫£n ph·∫©m</span>
                <button id="btnDownload" class="btn btn-outline-primary btn-sm"><i class="fa-solid fa-file-arrow-down me-1"></i>T·∫£i danh s√°ch</button>
              </div>
            </div>
            <div class="card-body">
              <div id="pricingTable" class="pricing-grid">
                <div class="pricing-empty">ƒêang t·∫£i d·ªØ li·ªáu...</div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div id="defaultPricingData" class="d-none">
    <div data-ma="KN001" data-ten="GOOD ENERGY - NƒÇNG L∆Ø·ª¢NG T·ªêT" data-loai="K·ªπ nƒÉng s·ªëng" data-gia="85000" data-giagoc="120000"></div>
    <div data-ma="KN002" data-ten="NGH·ªÜ THU·∫¨T T∆Ø DUY LOGIC" data-loai="K·ªπ nƒÉng s·ªëng" data-gia="126000" data-giagoc="169000"></div>
    <div data-ma="KN003" data-ten="K·ª∏ NƒÇNG T∆Ø DUY TH·ª∞C CHI·∫æN" data-loai="K·ªπ nƒÉng s·ªëng" data-gia="126000" data-giagoc="169000"></div>
    <div data-ma="TN001" data-ten="THI√äN NHI√äN - T·∫†I SAO CH√öNG TA C·∫¶N THI√äN NHI√äN XANH T∆Ø∆†I?" data-loai="Thi·∫øu nhi" data-gia="52000" data-giagoc="70000"></div>
    <div data-ma="TN002" data-ten="G·ª¢I M·ªû TR√ç T∆Ø·ªûNG T∆Ø·ª¢NG - N·ªñI BU·ªíN C·ª¶A C√ÇY √çCH K·ª∂" data-loai="Thi·∫øu nhi" data-gia="28000" data-giagoc="35000"></div>
    <div data-ma="TN003" data-ten="R√àN TR√ç TH√îNG MINH - T·∫¨P 3" data-loai="Thi·∫øu nhi" data-gia="24000" data-giagoc="30000"></div>
    <div data-ma="VN001" data-ten="RU·ªíI TR√ÇU (T√ÅI B·∫¢N NƒÇM 2018)" data-loai="VƒÉn h·ªçc" data-gia="96000" data-giagoc="128000"></div>
    <div data-ma="VH002" data-ten="VƒÇN H·ªåC KINH ƒêI·ªÇN - L·ªÄ TH√ìI TH·ªä TH√ÄNH" data-loai="VƒÉn h·ªçc" data-gia="164000" data-giagoc="205000"></div>
    <div data-ma="VH003" data-ten="VƒÇN H·ªåC KINH ƒêI·ªÇN - CH√ÇN DUNG M·ªòT CU·ªòC H√îN NH√ÇN" data-loai="VƒÉn h·ªçc" data-gia="215000" data-giagoc="225000"></div>
    <div data-ma="KT001" data-ten="THE LITTLE BOOK - ƒê·∫¶U T∆Ø THEO CHI·∫æN L∆Ø·ª¢C PH√íNG TH·ª¶" data-loai="Kinh t·∫ø" data-gia="134000" data-giagoc="179500"></div>
    <div data-ma="KT002" data-ten="T∆Ø DUY ƒê·∫¶U T∆Ø - TI·ªÄN ƒê·∫∫ RA TI·ªÄN" data-loai="Kinh t·∫ø" data-gia="203000" data-giagoc="239000"></div>
    <div data-ma="KT003" data-ten="TI·ªÄN ƒê·∫∫ RA TI·ªÄN - ƒê·∫¶U T∆Ø T√ÄI CH√çNH TH√îNG MINH" data-loai="Kinh t·∫ø" data-gia="128000" data-giagoc="160000"></div>
    <div data-ma="GK001" data-ten="TUY·ªÇN T·∫¨P B√ÄI VƒÇN NGH·ªä LU·∫¨N X√É H·ªòI CHON L·ªåC" data-loai="Gi√°o khoa" data-gia="90000" data-giagoc="120000"></div>
    <div data-ma="GK002" data-ten="LUY·ªÜN THI V√ÄO 10 NG·ªÆ VƒÇN - CHINH PH·ª§C B√ÄI NGH·ªä LU·∫¨N" data-loai="Gi√°o khoa" data-gia="71500" data-giagoc="89000"></div>
    <div data-ma="GK003" data-ten="TAKENOTE NG·ªÆ PH√ÅP TR·ªåNG ƒêI·ªÇM TI·∫æNG ANH TRUNG H·ªåC C∆† S·ªû" data-loai="Gi√°o khoa" data-gia="71200" data-giagoc="89000"></div>
  </div>
  <div id="feedback" class="feedback d-none">
    <div class="alert alert-success shadow mb-0" role="alert">
      <span id="feedbackText">ƒê√£ c·∫≠p nh·∫≠t gi√°.</span>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      let state = [];
      let productData = [];
      const el = {
        table: document.getElementById('pricingTable'),
        summary: document.getElementById('tableSummary'),
        downloadBtn: document.getElementById('btnDownload'),
        feedback: document.getElementById('feedback'),
        feedbackText: document.getElementById('feedbackText')
      };

      const readDefaultProductsFromDOM = () => {
        const container = document.getElementById('defaultPricingData');
        if (!container) return [];
        return Array.from(container.querySelectorAll('[data-ma]')).map((item) => ({
          ma: item.dataset.ma || '',
          ten: item.dataset.ten || '',
          loai: item.dataset.loai || '',
          gia: Number(item.dataset.gia) || 0,
          giagoc: Number(item.dataset.giagoc) || 0
        }));
      };

      const getProducts = () => {
        if (!productData.length) {
          productData = readDefaultProductsFromDOM();
        }
        return productData;
      };

      const formatCurrency = (value) =>
        Number(value || 0).toLocaleString('vi-VN', { style: 'currency', currency: 'VND' }).replace('‚Ç´', 'ƒë');

      const calcProfitPercent = (cost, price) => {
        if (!cost) return 0;
        return Math.round(((price - cost) / cost) * 1000) / 10;
      };

      const clampPercent = (value, min, max) => {
        if (!Number.isFinite(value)) return null;
        if (min !== undefined && value < min) return min;
        if (max !== undefined && value > max) return max;
        return value;
      };

      const roundPriceValue = (value) => {
        const numeric = Number(value);
        if (!Number.isFinite(numeric)) return '';
        return Math.max(0, Math.round(numeric));
      };

      const removeAccents = (str = '') =>
        str
          .toString()
          .normalize('NFD')
          .replace(/[\u0300-\u036f]/g, '')
          .replace(/ƒë/g, 'd')
          .replace(/ƒê/g, 'D');

      const showFeedback = (msg) => {
        if (!el.feedback) return;
        el.feedbackText.textContent = msg;
        el.feedback.classList.remove('d-none');
        setTimeout(() => el.feedback.classList.add('d-none'), 2200);
      };

      const toNumber = (value) => {
        if (typeof value === 'number' && Number.isFinite(value)) return value;
        if (!value) return 0;
        const numeric = Number(value.toString().replace(/[^\d.-]/g, ''));
        return Number.isFinite(numeric) ? numeric : 0;
      };

      const sanitizeKey = (value) =>
        removeAccents(value.toString())
          .toLowerCase()
          .replace(/\s+/g, '-')
          .replace(/[^a-z0-9-_]/g, '');

      const buildKey = (product, index) => {
        if (product && product.id !== undefined && product.id !== null) return `id-${product.id}`;
        if (product && product.ma) return `code-${sanitizeKey(product.ma)}`;
        return `idx-${index}`;
      };

      const normalizeCategories = (value) => {
        if (Array.isArray(value)) return value.filter(Boolean);
        if (typeof value === 'string' && value.trim()) {
          return value
            .split(',')
            .map((item) => item.trim())
            .filter(Boolean);
        }
        return [];
      };

      const normalizeProducts = (products) =>
        products.map((product, index) => {
          const categories = normalizeCategories(product?.loai);
          const code = (product?.ma || '').toString().trim();
          return {
            key: buildKey(product, index),
            storageIndex: index,
            code: code || `SP-${String(index + 1).padStart(3, '0')}`,
            name: product?.ten || 'Ch∆∞a c·∫≠p nh·∫≠t t√™n',
            categories: categories.length ? categories : ['Kh√°c'],
            cost: toNumber(product?.giagoc),
            price: toNumber(product?.gia)
          };
        });

      const syncState = () => {
        state = normalizeProducts(getProducts());
      };

      const getPriceInputTarget = (inputEl) => {
        if (!inputEl) return null;
        const targetId = inputEl.dataset.target;
        return targetId ? document.getElementById(targetId) : null;
      };

      const applyProfitPercent = (inputEl) => {
        const cost = Number(inputEl?.dataset.cost) || 0;
        if (!cost) return;
        if (inputEl.value === '') return;
        const percent = clampPercent(Number(inputEl.value), -99, 999);
        if (percent === null) return;
        inputEl.value = percent;
        const targetInput = getPriceInputTarget(inputEl);
        if (!targetInput) return;
        const computed = cost * (1 + percent / 100);
        targetInput.value = roundPriceValue(computed);
      };

      const renderTable = () => {
        if (!el.table) return;
        const rows = [...state];
        const total = rows.length;
        el.summary.textContent = `${total} s·∫£n ph·∫©m`;

        if (!rows.length) {
          const message = state.length
            ? 'Kh√¥ng t√¨m th·∫•y s·∫£n ph·∫©m ph√π h·ª£p.'
            : 'Ch∆∞a c√≥ d·ªØ li·ªáu. Vui l√≤ng th√™m s√°ch t·∫°i trang Qu·∫£n l√Ω S·∫£n ph·∫©m.';
          el.table.innerHTML = `<div class="pricing-empty">${message}</div>`;
          return;
        }

        el.table.innerHTML = rows
          .map((p) => {
            const profit = calcProfitPercent(p.cost, p.price);
            const profitValue = p.price - p.cost;
            const inputId = `price-${p.storageIndex}`;
            const profitInputValue = Number.isFinite(profit) ? profit : '';
            return `
              <div class="price-card">
                <div class="price-card__header">
                  <div>
                    <div class="price-card__code">${p.code}</div>
                    <div class="price-card__categories">${p.categories.join(', ')}</div>
                  </div>
                  <span class="badge bg-success-subtle text-success fw-semibold">${profit}%</span>
                </div>
                <div class="price-card__title">${p.name}</div>
                <div class="price-card__metrics">
                  <div class="price-card__metric">
                    <span>Gi√° v·ªën</span>
                    <strong>${formatCurrency(p.cost)}</strong>
                  </div>
                  <div class="price-card__metric">
                    <span>L·ª£i nhu·∫≠n ∆∞·ªõc t√≠nh</span>
                    <strong>${formatCurrency(profitValue)}</strong>
                    <small>${profit >= 0 ? '+' : ''}${profit}%</small>
                  </div>
                </div>
                <div class="price-card__price">
                  <span class="text-muted small text-uppercase">Gi√° b√°n hi·ªán t·∫°i</span>
                  <div class="price-card__actions">
                    <input
                      id="${inputId}"
                      type="text"
                      class="form-control price-input"
                      data-index="${p.storageIndex}"
                      data-key="${p.key}"
                      value="${p.price || ''}"
                      min="0"
                      readonly
                    >
                    <button
                      class="btn btn-success update-price"
                      data-input="${inputId}"
                      data-index="${p.storageIndex}"
                      data-key="${p.key}"
                    >
                      <i class="fa-solid fa-floppy-disk me-1"></i>L∆∞u gi√°
                    </button>
                  </div>
                  <div class="price-card__adjust mt-2">
                    <label>L·ª£i nhu·∫≠n (%)</label>
                    <input
                      type="number"
                      class="form-control form-control-sm profit-input"
                      data-target="${inputId}"
                      data-cost="${p.cost}"
                      value="${profitInputValue}"
                      placeholder="+10"
                    >
                  </div>
                </div>
              </div>
            `;
          })
          .join('');
      };

      const findProductIndex = (dataset, products) => {
        if (dataset.index !== undefined) {
          const parsed = parseInt(dataset.index, 10);
          if (!Number.isNaN(parsed) && products[parsed]) return parsed;
        }
        if (dataset.key) {
          return products.findIndex((product, idx) => buildKey(product, idx) === dataset.key);
        }
        return -1;
      };

      const handlePriceUpdate = (dataset) => {
        const input = dataset.input ? document.getElementById(dataset.input) : null;
        if (!input) {
          alert('Kh√¥ng th·ªÉ x√°c ƒë·ªãnh √¥ nh·∫≠p gi√° c·∫ßn c·∫≠p nh·∫≠t.');
          return;
        }
        const value = Number(input.value);
        if (Number.isNaN(value) || value <= 0) {
          alert('Vui l√≤ng nh·∫≠p gi√° b√°n h·ª£p l·ªá.');
          return;
        }

        const products = getProducts();
        const targetIndex = findProductIndex(dataset, products);
        if (targetIndex === -1) {
          alert('Kh√¥ng t√¨m th·∫•y s·∫£n ph·∫©m ƒë·ªÉ c·∫≠p nh·∫≠t. Vui l√≤ng t·∫£i l·∫°i trang.');
          return;
        }

        products[targetIndex].gia = value;
        syncState();
        renderTable();

        const updated = state.find((item) => item.storageIndex === targetIndex) || state.find((item) => item.key === dataset.key);
        showFeedback(`ƒê√£ c·∫≠p nh·∫≠t gi√° cho ${updated?.name || 's·∫£n ph·∫©m'}.`);
      };

      document.addEventListener('click', (e) => {
        if (e.target.closest('.update-price')) {
          const btn = e.target.closest('.update-price');
          handlePriceUpdate(btn.dataset);
        }
      });

      document.addEventListener('input', (e) => {
        if (e.target.matches('.profit-input')) {
          applyProfitPercent(e.target);
        }
      });

      el.downloadBtn?.addEventListener('click', () => {
        const data = getProducts();
        const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'thuc-store-pricing.json';
        a.click();
        URL.revokeObjectURL(url);
      });

      syncState();
      renderTable();
    });
  </script>
</body>
</html>
