<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Admin - Qu·∫£n l√Ω Gi√° | Th·ª©c Store</title>

  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">

  <style>
    body { background:#f3f8f3; font-family:"Open Sans",sans-serif; }
  .admin-banner { background: linear-gradient(0deg, rgba(0,80,40,0.45), rgba(0,80,40,0.45)), url('../img/banner.jpg') center/cover no-repeat; height:180px; border-radius:12px; color:#fff; display:flex; align-items:center; justify-content:center; margin-bottom:1.5rem;}
    .sidebar { background:#fff; border-radius:1rem; padding:1.5rem; box-shadow:0 3px 10px rgba(0,0,0,0.08); }
    .menu-item{ display:flex; align-items:center; color:#2d6a4f; font-weight:600; text-decoration:none; margin-bottom:0.8rem; }
    .content-area{ background:#fff; padding:1.5rem; border-radius:1rem; box-shadow:0 3px 8px rgba(0,0,0,0.04); min-height:65vh; }
  </style>
</head>
<body>
  <div class="container-fluid py-4">
    <div class="admin-banner">
      <div class="text-center">
        <h1 class="h2 fw-bold">Th·ª©c Store Admin</h1>
        <div class="small">Qu·∫£n l√Ω % l·ª£i nhu·∫≠n & Gi√° b√°n</div>
      </div>
    </div>

    <div class="row g-4">
      <div class="col-lg-3">
        <div class="sidebar">
          <h5 class="text-success">üìã Menu qu·∫£n l√Ω</h5>
          <a href="giao-dien-chinh-admin.html" class="menu-item"><span class="me-2">üè†</span> Trang ch·ªß Admin</a>
          <a href="pricing.html" class="menu-item"><span class="me-2">üí≤</span> Qu·∫£n l√Ω Gi√°</a>
          <hr>
          <div class="mt-3">
            <button id="btnLoad" class="btn btn-outline-success btn-sm">L√†m m·ªõi</button>
            <div class="text-muted small mt-2">Thi·∫øt l·∫≠p k·∫ø th·ª´a % theo lo·∫°i ho·∫∑c % theo s·∫£n ph·∫©m</div>
          </div>
        </div>
      </div>

      <div class="col-lg-9">
        <div class="content-area">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h4 class="text-success m-0">Qu·∫£n l√Ω Gi√° B√°n</h4>
            <div><button id="btnExport" class="btn btn-outline-secondary btn-sm">Xu·∫•t S·∫£n ph·∫©m</button></div>
          </div>

          <div class="row g-4">
            <div class="col-md-5">
              <div class="card">
                <div class="card-body">
                  <h6>Thi·∫øt l·∫≠p % l·ª£i nhu·∫≠n theo Lo·∫°i</h6>
                  <div class="mb-3">
                    <label class="form-label">Ch·ªçn Lo·∫°i</label>
                    <select id="catSelect" class="form-select"></select>
                  </div>
                  <div class="mb-3">
                    <label class="form-label">% L·ª£i nhu·∫≠n (v√≠ d·ª• 20)</label>
                    <input id="catProfit" class="form-control" type="number" step="0.1" placeholder="Nh·∫≠p %">
                  </div>
                  <button id="saveCatProfit" class="btn btn-success">L∆∞u thi·∫øt l·∫≠p</button>
                </div>
              </div>
            </div>

            <div class="col-md-7">
              <div>
                <div class="d-flex mb-2">
                  <input id="qProduct" class="form-control me-2" placeholder="T√¨m theo m√£ s·∫£n ph·∫©m...">
                  <button id="btnSearch" class="btn btn-outline-success">T√¨m</button>
                </div>
                <div class="table-responsive">
                  <table class="table table-striped align-middle">
                    <thead class="table-light">
                      <tr><th>S·∫£n ph·∫©m</th><th>Gi√° v·ªën</th><th>% l·ª£i nhu·∫≠n</th><th>Gi√° b√°n</th><th>H√†nh ƒë·ªông</th></tr>
                    </thead>
                    <tbody id="productsTable"></tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>

        </div>
      </div>
    </div>
  </div>

  <script>
    const K = { cats:'book_cats', prods:'book_prods', receipts:'book_receipts', sales:'book_sales' };
    function ensureSample(){
      if (!localStorage.getItem(K.cats)) localStorage.setItem(K.cats, JSON.stringify([{id:'cat1',name:'Ti·ªÉu thuy·∫øt'},{id:'cat2',name:'K·ªπ thu·∫≠t & CNTT'},{id:'cat3',name:'Thi·∫øu nhi'}]));
      if (!localStorage.getItem(K.prods)) localStorage.setItem(K.prods, JSON.stringify([
        { id:'p1', title:'S√°ch Ti·ªÉu thuy·∫øt A', categoryId:'cat1', cost:120000, stock:10, threshold:5, initialStock:10, productProfit:null },
        { id:'p2', title:'L·∫≠p tr√¨nh JS', categoryId:'cat2', cost:220000, stock:5, threshold:3, initialStock:5, productProfit:null },
        { id:'p3', title:'Truy·ªán Thi·∫øu Nhi B', categoryId:'cat3', cost:80000, stock:15, threshold:6, initialStock:15, productProfit:null }
      ]));
      if (!localStorage.getItem('book_category_profit')) localStorage.setItem('book_category_profit', JSON.stringify({ cat1:20, cat2:25, cat3:15 }));
    }
    ensureSample();
    const $ = s => document.querySelector(s);
    const $$ = s => Array.from(document.querySelectorAll(s));
    const catSelect = $('#catSelect'), catProfit = $('#catProfit'), saveCatProfit = $('#saveCatProfit');
    const productsTable = $('#productsTable'), qProduct = $('#qProduct'), btnLoad = $('#btnLoad'), btnExport = $('#btnExport'), btnSearch = $('#btnSearch');

    function read(k){ return JSON.parse(localStorage.getItem(k) || 'null'); }
    function write(k,v){ localStorage.setItem(k, JSON.stringify(v)); }

    function loadCats(){
      const cats = read(K.cats) || [];
      catSelect.innerHTML = '';
      cats.forEach(c => { const o = document.createElement('option'); o.value = c.id; o.textContent = c.name; catSelect.appendChild(o); });
      const cp = read('book_category_profit') || {};
      catProfit.value = cp[catSelect.value] ?? '';
    }

    catSelect.onchange = ()=> {
      const cp = read('book_category_profit') || {};
      catProfit.value = cp[catSelect.value] ?? '';
    };

    saveCatProfit.onclick = () => {
      const v = Number(catProfit.value);
      if (isNaN(v)) return alert('Nh·∫≠p % h·ª£p l·ªá.');
      const cp = read('book_category_profit') || {};
      cp[catSelect.value] = v;
      write('book_category_profit', cp);
      alert('ƒê√£ l∆∞u % l·ª£i nhu·∫≠n cho lo·∫°i.');
      renderProducts();
    };

    function calculateSelling(product){
      const catProf = read('book_category_profit') || {};
      const catPct = catProf[product.categoryId];
      const usedPct = product.productProfit != null ? product.productProfit : (catPct != null ? catPct : 0);
      const selling = Math.round(product.cost * (1 + usedPct/100));
      return { usedPct, selling };
    }

    function renderProducts(){
      // Load products from both older 'book_prods' namespace and admin product manager ('products')
      const prodsA = read(K.prods) || [];
      const rawB = JSON.parse(localStorage.getItem('products') || 'null') || [];
      // Map products from admin manager to the shape used by pricing page
      const prodsB = rawB.map((p, i) => ({
        id: p.ma || ('p_admin_' + i),
        ma: p.ma || '',
        title: p.ten || '',
        categoryId: Array.isArray(p.loai) ? p.loai[0] : (p.loai || ''),
        cost: Number(p.giagoc) || Number(p.gia) || 0,
        stock: p.stock || 0,
        threshold: p.threshold || 0,
        initialStock: p.initialStock || 0,
        productProfit: p.productProfit ?? null,
        _raw: p // keep raw for additional info like tacgia, nhaxuatban
      }));

      const prods = [...prodsA, ...prodsB];
      const q = (qProduct.value||'').toLowerCase().trim();
      productsTable.innerHTML = '';
      prods.forEach(p => {
        // T√¨m theo m√£ s·∫£n ph·∫©m (n·∫øu c√≥ tr∆∞·ªùng 'ma' th√¨ d√πng 'ma', n·∫øu kh√¥ng d√πng 'id')
        const code = ((p.ma || p.id) + '').toLowerCase();
        if (q && !code.includes(q)) return;
        const calc = calculateSelling(p);
        const tr = document.createElement('tr');
        // show extra metadata when available (from _raw)
        const extra = p._raw ? `<div class="text-muted small">M√£: ${p.ma || p.id} | T√°c gi·∫£: ${p._raw.tacgia || '-'} | NXB: ${p._raw.nhaxuatban || '-'}</div>` : `<div class="text-muted small">M√£: ${p.ma || p.id} | Lo·∫°i: ${p.categoryId || '-'}</div>`;
        tr.innerHTML = `
          <td>${p.title}${extra}</td>
          <td>${(p.cost||0).toLocaleString()} VND</td>
          <td>
            <input data-id="${p.id}" class="form-control form-control-sm prodProfit" style="width:100px" value="${p.productProfit ?? ''}" placeholder="inherit">
            <div class="text-muted small">S·ª≠ d·ª•ng: ${calc.usedPct}%</div>
          </td>
          <td>${calc.selling.toLocaleString()} VND</td>
          <td><button data-id="${p.id}" class="btn btn-sm btn-success saveProd">L∆∞u</button></td>
        `;
        productsTable.appendChild(tr);
      });
      $$('.saveProd').forEach(b => b.onclick = e => {
        const id = e.currentTarget.dataset.id;
        const input = document.querySelector(`input.prodProfit[data-id="${id}"]`);
        const v = input.value.trim();
        const prods = read(K.prods) || [];
        const p = prods.find(x=>x.id===id);
        if (!p) return alert('S·∫£n ph·∫©m kh√¥ng t·ªìn t·∫°i.');
        if (v === '') p.productProfit = null; else {
          const n = Number(v);
          if (isNaN(n)) return alert('Nh·∫≠p % h·ª£p l·ªá.');
          p.productProfit = n;
        }
        write(K.prods, prods);
        alert('ƒê√£ l∆∞u % l·ª£i nhu·∫≠n s·∫£n ph·∫©m.');
        renderProducts();
      });
    }

    btnLoad.onclick = () => { ensureSample(); loadCats(); renderProducts(); alert('L√†m m·ªõi xong'); };
    btnExport.onclick = () => { const p = read(K.prods) || []; const w = window.open(); w.document.write('<pre>'+JSON.stringify(p,null,2).replace(/</g,'&lt;')+'</pre>'); };
    btnSearch.onclick = () => renderProducts();

    function init(){ loadCats(); renderProducts(); }
    init();
  </script>
</body>
</html>