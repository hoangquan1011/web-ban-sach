<!-- chitietdonhang.html (phi√™n b·∫£n fixed - hi·ªÉn th·ªã s·∫£n ph·∫©m t·ª´ cart) -->
<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Chi ti·∫øt ƒê∆°n h√†ng - Th·ª©c Store</title>

  <!-- Bootstrap & Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="../css/admin-shared.css">

  <style>
    body { background-color: #f3f8f3; font-family: "Open Sans", sans-serif; }

    /* Content */
    .content-area {
      background: #fff; border-radius: 1rem;
      box-shadow: 0 3px 8px rgba(0,0,0,0.05);
      padding: 2rem; min-height: 75vh;
    }

    .table thead th { white-space: nowrap; }
    .form-text-sm { font-size: .85rem; color: #6c757d; }
    .currency { text-align: right; }
  </style>
</head>

<body>
  <div class="container-fluid py-4">
    <!-- Banner -->
    <div class="admin-banner">
      <h1>Th·ª©c Store Admin</h1>
      <p>Chi ti·∫øt ƒê∆°n h√†ng</p>
    </div>

    <div class="row">
      <!-- Sidebar -->
      <div class="col-lg-3 mb-4">
        <div class="sidebar">
          <h5>üìã Menu qu·∫£n l√Ω</h5>
          <a href="quanlysanpham.html" class="menu-item"><span class="emoji">üìò</span> Qu·∫£n l√Ω S·∫£n ph·∫©m</a>
          <a href="quanlydonhang.html" class="menu-item active"><span class="emoji">üßæ</span> Qu·∫£n l√Ω ƒê∆°n h√†ng</a>
          <a href="user.html" class="menu-item"><span class="emoji">üë§</span> Qu·∫£n l√Ω Ng∆∞·ªùi d√πng</a>
          <a href="stock.html" class="menu-item"><span class="emoji">üì¶</span> Qu·∫£n l√Ω Kho</a>
          <a href="pricing.html" class="menu-item"><span class="emoji">üí≤</span> Qu·∫£n l√Ω Gi√°</a>
          <a href="import.html" class="menu-item"><span class="emoji">üöö</span> Nh·∫≠p h√†ng</a>
        </div>
      </div>

      <!-- Content -->
      <div class="col-lg-9">
        <div class="content-area">
          <div class="d-flex justify-content-between align-items-center mb-4">
            <h4 class="text-success fw-bold">Chi ti·∫øt ƒê∆°n h√†ng</h4>
            <div class="d-flex gap-2">
              <a href="quanlydonhang.html" class="btn btn-outline-success btn-sm">
                <i class="fa fa-arrow-left"></i> Quay l·∫°i
              </a>
            </div>
          </div>

          <!-- Th√¥ng tin ƒë∆°n h√†ng -->
          <div class="mb-4">
            <h5 class="fw-bold text-secondary mb-3">üßæ Th√¥ng tin ƒë∆°n h√†ng</h5>
            <div class="row g-3">
              <div class="col-md-4">
                <label class="form-label fw-semibold">M√£ ƒë∆°n h√†ng</label>
                <input type="text" class="form-control" id="orderId" readonly>
              </div>
              <div class="col-md-4">
                <label class="form-label fw-semibold">Ng√†y ƒë·∫∑t</label>
                <input type="datetime-local" class="form-control" id="orderDate">
              </div>
              <div class="col-md-4">
                <label class="form-label fw-semibold">T√¨nh tr·∫°ng</label>
                <select class="form-select" id="orderStatus">
                  <option value="moi-dat">M·ªõi ƒë·∫∑t</option>
                  <option value="da-xu-ly">ƒê√£ x·ª≠ l√Ω</option>
                  <option value="da-giao">ƒê√£ giao</option>
                  <option value="huy">H·ªßy</option>
                </select>
              </div>

              <div class="col-12"><hr class="my-3"></div>

              <div class="col-md-6">
                <label class="form-label fw-semibold">H·ªç t√™n kh√°ch h√†ng</label>
                <input type="text" class="form-control" id="customerName" placeholder="Nguy·ªÖn VƒÉn A" required>
              </div>
              <div class="col-md-3">
                <label class="form-label fw-semibold">S·ªë ƒëi·ªán tho·∫°i</label>
                <input type="tel" class="form-control" id="customerPhone" placeholder="09xxxxxxxx">
              </div>
              <div class="col-md-3">
                <label class="form-label fw-semibold">Email</label>
                <input type="email" class="form-control" id="customerEmail" placeholder="name@email.com">
              </div>
              <div class="col-md-12">
                <label class="form-label fw-semibold">ƒê·ªãa ch·ªâ giao h√†ng</label>
                <input type="text" class="form-control" id="address" placeholder="S·ªë nh√†, ƒë∆∞·ªùng, ph∆∞·ªùng, qu·∫≠n, t·ªânh/th√†nh">
              </div>
            </div>
          </div>

          <!-- Danh s√°ch s·∫£n ph·∫©m -->
          <div class="mb-4">
            <div class="d-flex justify-content-between align-items-center mb-2">
              <h5 class="fw-bold text-secondary">üì¶ S·∫£n ph·∫©m trong ƒë∆°n h√†ng</h5>
            </div>

            <div class="table-responsive">
              <table class="table table-bordered align-middle text-center">
                <thead class="table-success">
                  <tr>
                    <th style="width:60px">STT</th>
                    <th>T√™n s·∫£n ph·∫©m</th>
                    <th style="width:120px">S·ªë l∆∞·ª£ng</th>
                    <th style="width:160px">ƒê∆°n gi√° (ƒë)</th>
                    <th style="width:160px">Th√†nh ti·ªÅn (ƒë)</th>
                  </tr>
                </thead>
                <tbody id="productList"></tbody>
              </table>
            </div>
          </div>

          <!-- T·ªïng ti·ªÅn -->
          <div class="row g-3">
            <div class="col-lg-6">
              <label class="form-label fw-semibold">Ghi ch√∫</label>
              <textarea id="note" class="form-control" rows="3" placeholder="(Tu·ª≥ ch·ªçn)"></textarea>
            </div>
            <div class="col-lg-6">
              <div class="bg-light rounded p-3">
                <div class="d-flex justify-content-between mb-2">
                  <span>T·∫°m t√≠nh</span>
                  <strong id="subtotal">0ƒë</strong>
                </div>
                <div class="d-flex justify-content-between mb-2 align-items-center">
                  <span>Ph√≠ v·∫≠n chuy·ªÉn</span>
                  <strong class="text-end" id="shippingDisplay">30,000ƒë</strong>
                </div>
                <hr>
                <div class="d-flex justify-content-between">
                  <h5>T·ªïng c·ªông</h5>
                  <h5 id="grandTotal" class="text-success">0ƒë</h5>
                </div>
              </div>
            </div>
          </div>

          <div id="statusMessage" class="text-success fw-semibold mt-3"></div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ====== TI·ªÜN √çCH ======
    const fmt = (n) => (Number(n) || 0).toLocaleString('vi-VN') + 'ƒë';
    const parseNum = (v) => Math.max(0, Number(v) || 0);
    const pad2 = (value) => String(value).padStart(2, '0');
    const toDatetimeLocalValue = (value) => {
      if (!value) return '';
      const date = new Date(value);
      if (Number.isNaN(date.getTime())) return '';
      return `${date.getFullYear()}-${pad2(date.getMonth() + 1)}-${pad2(date.getDate())}T${pad2(date.getHours())}:${pad2(date.getMinutes())}`;
    };
    const inputValueToISO = (value) => {
      if (!value) return new Date().toISOString();
      const date = new Date(value);
      return Number.isNaN(date.getTime()) ? new Date().toISOString() : date.toISOString();
    };

    // Map tr·∫°ng th√°i UI <-> n·ªôi b·ªô (t∆∞∆°ng th√≠ch trang c≈©)
    const uiToInternal = { 'moi-dat': 'chua-xu-ly', 'da-xu-ly': 'hoan-thanh', 'da-giao': 'dang-giao', 'huy': 'da-huy' };
    const internalToUi = { 'chua-xu-ly': 'moi-dat', 'hoan-thanh': 'da-xu-ly', 'dang-giao': 'da-giao', 'da-huy': 'huy' };

    // ====== DOM ELEMENTS ======
    const orderIdInput = document.getElementById('orderId');
    const orderDateInput = document.getElementById('orderDate');
    const orderStatusSelect = document.getElementById('orderStatus');
    const nameInput = document.getElementById('customerName');
    const phoneInput = document.getElementById('customerPhone');
    const emailInput = document.getElementById('customerEmail');
    const addressInput = document.getElementById('address');
    const noteInput = document.getElementById('note');
    const tbody = document.getElementById('productList');
    const subtotalEl = document.getElementById('subtotal');
    const grandEl = document.getElementById('grandTotal');
    const shippingDisplay = document.getElementById('shippingDisplay');
    const statusMessage = document.getElementById('statusMessage');
    const btnSave = document.getElementById('btnSave');

    // ====== STATE ======
    let orders = JSON.parse(localStorage.getItem('orders') || '[]');
    let order = null;

    // ====== KH·ªûI T·∫†O ======
    (function init() {
      const params = new URLSearchParams(window.location.search);
      const orderIdParam = params.get('id');

      console.log('üîç Loading order:', orderIdParam);
      console.log('üì¶ All orders:', orders);

      if (orderIdParam) {
        order = orders.find(o => String(o.id) === String(orderIdParam)) || null;
        console.log('‚úÖ Found order:', order);
      }

      if (!order) {
        // T·∫°o m·ªõi
        order = {
          id: `ORD-${Date.now()}`,
          date: new Date().toISOString(),
          customer: { name: '', phone: '', email: '', address: '' },
          items: [],
          note: '',
          status: 'chua-xu-ly',
          totals: { subtotal: 0, shipping: 30000, discount: 0, total: 0 }
        };
      } else {
        // Chu·∫©n h√≥a d·ªØ li·ªáu ƒë∆°n h√†ng t·ª´ cart
        if (!order.items) order.items = [];
        
        // X·ª≠ l√Ω tr∆∞·ªùng h·ª£p items c√≥ th·ªÉ l√† products ho·∫∑c cartItems
        if (!order.items.length && order.products) {
          console.log('üîÑ Converting products to items');
          order.items = order.products;
        }
        if (!order.items.length && order.cartItems) {
          console.log('üîÑ Converting cartItems to items');
          order.items = order.cartItems;
        }
        
        // Chu·∫©n h√≥a c·∫•u tr√∫c t·ª´ng item (x·ª≠ l√Ω nhi·ªÅu ƒë·ªãnh d·∫°ng kh√°c nhau)
        order.items = order.items.map(item => {
          console.log('üîß Processing item:', item);
          return {
            name: item.name || item.productName || item.title || '',
            qty: item.qty || item.quantity || item.amount || 1,
            price: item.price || item.unitPrice || item.pricePerUnit || 0
          };
        });

        console.log('‚úÖ Normalized items:', order.items);

        // Chu·∫©n h√≥a totals
        if (!order.totals) {
          order.totals = {
            subtotal: order.subtotal || 0,
            shipping: order.shipping || 30000,
            discount: order.discount || 0,
            total: order.total || order.totalAmount || 0
          };
        }
      }

      const parsedDate = order.date ? new Date(order.date) : new Date();
      order.date = Number.isNaN(parsedDate.getTime()) ? new Date().toISOString() : parsedDate.toISOString();

      // Render form
      orderIdInput.value = order.id;
      orderDateInput.value = toDatetimeLocalValue(order.date) || toDatetimeLocalValue(new Date().toISOString());
      orderStatusSelect.value = internalToUi[order.status] || 'moi-dat';
      nameInput.value = order.customer?.name || '';
      phoneInput.value = order.customer?.phone || '';
      emailInput.value = order.customer?.email || '';
      addressInput.value = order.customer?.address || '';
      noteInput.value = order.note || '';
      order.totals.shipping = 30000;
      order.totals.discount = 0;
      shippingDisplay.textContent = fmt(order.totals.shipping);

      renderItems();
      recalcTotals();
    })();

    // ====== S·∫¢N PH·∫®M ======
    function renderItems() {
      console.log('üé® Rendering items:', order.items);
      
      if (!order.items || order.items.length === 0) {
        tbody.innerHTML = `<tr><td colspan="5" class="text-muted">Ch∆∞a c√≥ s·∫£n ph·∫©m trong ƒë∆°n.</td></tr>`;
        return;
      }

      tbody.innerHTML = '';
      order.items.forEach((it, idx) => tbody.appendChild(makeRow(it, idx)));
    }

    function makeRow(item, idx) {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${idx + 1}</td>
        <td><input type="text" class="form-control" value="${item.name || ''}" placeholder="T√™n s·∫£n ph·∫©m" /></td>
        <td><input type="number" class="form-control text-end" min="1" value="${item.qty || 1}" /></td>
        <td><input type="number" class="form-control text-end" min="0" value="${item.price || 0}" /></td>
        <td class="currency">${fmt((item.qty || 1) * (item.price || 0))}</td>
      `;

      const [nameEl, qtyEl, priceEl] = [tr.children[1].firstElementChild, tr.children[2].firstElementChild, tr.children[3].firstElementChild];
      const totalCell = tr.children[4];

      const onChange = () => {
        item.name = nameEl.value.trim();
        item.qty = parseNum(qtyEl.value) || 1;
        item.price = parseNum(priceEl.value);
        totalCell.textContent = fmt(item.qty * item.price);
        recalcTotals();
      };

      nameEl.addEventListener('input', onChange);
      qtyEl.addEventListener('input', onChange);
      priceEl.addEventListener('input', onChange);

      return tr;
    }

    // ====== T√çNH TI·ªÄN ======
    function recalcTotals() {
      const subtotal = (order.items || []).reduce((s, it) => s + (parseNum(it.qty) * parseNum(it.price)), 0);
      const shipping = 30000;
      const discount = 0;
      const total = Math.max(0, subtotal + shipping - discount);

      order.totals = { subtotal, shipping, discount, total };
      order.date = inputValueToISO(orderDateInput.value);

      subtotalEl.textContent = fmt(subtotal);
      shippingDisplay.textContent = fmt(shipping);
      grandEl.textContent = fmt(total);
    }

    // ====== L∆ØU ======
    btnSave.addEventListener('click', () => {
      // Validate t·ªëi thi·ªÉu
      if (!nameInput.value.trim()) {
        alert('Vui l√≤ng nh·∫≠p t√™n kh√°ch h√†ng');
        nameInput.focus();
        return;
      }

      // ƒê·ªìng b·ªô state t·ª´ form -> object
      order.id = String(orderIdInput.value).trim();
      order.date = inputValueToISO(orderDateInput.value);
      order.status = uiToInternal[orderStatusSelect.value] || 'chua-xu-ly';
      order.customer = {
        name: nameInput.value.trim(),
        phone: phoneInput.value.trim(),
        email: emailInput.value.trim(),
        address: addressInput.value.trim(),
      };
      order.note = noteInput.value.trim();

      // L·ªçc b·ªè d√≤ng s·∫£n ph·∫©m tr·ªëng
      order.items = (order.items || []).filter(it => (it.name || '').trim() !== '' && parseNum(it.qty) > 0);

      // Kh√¥ng cho l∆∞u n·∫øu ch∆∞a c√≥ s·∫£n ph·∫©m
      if (order.items.length === 0) {
        alert('Vui l√≤ng th√™m √≠t nh·∫•t 1 s·∫£n ph·∫©m.');
        return;
      }

      // C·∫≠p nh·∫≠t totals
      recalcTotals();

      // Ghi v√†o localStorage
      const idx = orders.findIndex(o => String(o.id) === String(order.id));
      if (idx === -1) {
        orders.push(order);
      } else {
        orders[idx] = order;
      }
      localStorage.setItem('orders', JSON.stringify(orders));

      console.log('üíæ Saved order:', order);

      statusMessage.textContent = 'ƒê√£ l∆∞u ƒë∆°n h√†ng th√†nh c√¥ng!';
      setTimeout(() => statusMessage.textContent = '', 2500);
    });

    // ====== ƒê·ªíNG B·ªò TR·∫†NG TH√ÅI UI -> TOTALS khi s·ª≠a tr·ª±c ti·∫øp ======
    orderStatusSelect.addEventListener('change', () => {
      order.status = uiToInternal[orderStatusSelect.value] || 'chua-xu-ly';
    });

    // L·∫Øng nghe thay ƒë·ªïi ƒë·ªÉ c·∫≠p nh·∫≠t object khi ch·ªânh s·ª≠a tr∆∞·ªùng text
    ;[nameInput, phoneInput, emailInput, addressInput, noteInput].forEach(el => {
      el.addEventListener('input', () => {
        order.customer = order.customer || {};
        order.customer.name = nameInput.value.trim();
        order.customer.phone = phoneInput.value.trim();
        order.customer.email = emailInput.value.trim();
        order.customer.address = addressInput.value.trim();
        order.note = noteInput.value.trim();
      });
    });
  </script>
</body>
</html>
