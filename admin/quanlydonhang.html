<!-- File: quanlydonhang.html -->
<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Qu·∫£n l√Ω ƒê∆°n h√†ng - Th·ª©c Store</title>

  <!-- Bootstrap & Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">

  <style>
    body { background-color: #f3f8f3; font-family: "Open Sans", sans-serif; }
    .admin-banner {
      background: url('../img/banner.jpg') center/cover no-repeat;
      height: 220px; display: flex; align-items: center; justify-content: center;
      position: relative; border-radius: 12px; margin-bottom: 2rem; overflow: hidden;
    }
    .admin-banner::after {
      content: ""; position: absolute; inset: 0; background: rgba(0, 80, 40, 0.45);
    }
    .admin-banner h1 {
      position: relative; color: #fff; font-weight: 800;
      font-size: 3rem; z-index: 2;
    }
    .admin-banner p {
      position: absolute; bottom: 18px; font-size: 1rem;
      color: #eafbea; z-index: 2;
    }

    .sidebar {
      background-color: #ffffff;
      border-radius: 1rem;
      box-shadow: 0 3px 10px rgba(0,0,0,0.1);
      padding: 1.5rem;
      height: 100%;
    }
    .menu-item { 
      display: flex; align-items: center; color: #2d6a4f; 
      font-weight: 600; text-decoration: none; margin-bottom: 1rem; 
      transition: .3s; 
    }
    .menu-item:hover { color: #40916c; transform: translateX(5px); }
    .menu-item.active { color: #1b4332; font-weight: 700; }
    .content-area {
      background: #fff; border-radius: 1rem;
      box-shadow: 0 3px 8px rgba(0,0,0,0.05);
      padding: 2rem; min-height: 75vh;
    }
    .btn-view {
      background: #2d6a4f; color: #fff; border: none;
      padding: 4px 10px; border-radius: 4px; text-decoration: none;
    }
    .btn-view:hover { background: #1b4332; color: #fff; }
    
    .status-badge {
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 0.85rem;
      font-weight: 600;
    }
    .status-chua-xu-ly { background: #fff3cd; color: #856404; }
    .status-dang-giao { background: #cfe2ff; color: #084298; }
    .status-hoan-thanh { background: #d1e7dd; color: #0f5132; }
    .status-da-huy { background: #f8d7da; color: #842029; }

    .username-display {
      font-weight: 600;
      color: #2d6a4f;
    }
    
    .filter-section {
      background: #f8f9fa;
      padding: 1rem;
      border-radius: 8px;
      margin-bottom: 1.5rem;
    }
  </style>
</head>

<body>
  <div class="container-fluid py-4">
    <div class="admin-banner">
      <h1>Th·ª©c Store Admin</h1>
      <p>Qu·∫£n l√Ω ƒê∆°n h√†ng</p>
    </div>

    <div class="row">
      <div class="col-lg-3 mb-4">
        <div class="sidebar">
          <h5>üìã Menu qu·∫£n l√Ω</h5>
          <a href="quanlysanpham.html" class="menu-item"><span class="emoji">üìò</span> Qu·∫£n l√Ω S·∫£n ph·∫©m</a>
          <a href="quanlydonhang.html" class="menu-item active"><span class="emoji">üßæ</span> Qu·∫£n l√Ω ƒê∆°n h√†ng</a>
          <a href="user.html" class="menu-item"><span class="emoji">üë§</span> Qu·∫£n l√Ω Ng∆∞·ªùi d√πng</a>
          <a href="stock.html" class="menu-item"><span class="emoji">üì¶</span> Qu·∫£n l√Ω Kho</a>
          <a href="pricing.html" class="menu-item"><span class="emoji">üí≤</span> Qu·∫£n l√Ω Gi√°</a>
          <a href="import.html" class="menu-item"><span class="emoji">üöö</span> Nh·∫≠p h√†ng</a>
        </div>
      </div>

      <div class="col-lg-9">
        <div class="content-area">
          <div class="d-flex justify-content-between align-items-center mb-4">
            <h4 class="text-success fw-bold">Qu·∫£n l√Ω ƒê∆°n h√†ng</h4>
            <button class="btn btn-sm btn-success">ƒêƒÉng xu·∫•t</button>
          </div>

          <!-- B·ªô l·ªçc -->
          <div class="filter-section">
            <div class="row g-3 align-items-end">
              <div class="col-md-3">
                <label class="form-label fw-semibold">T√¨m theo m√£ ƒë∆°n</label>
                <input type="text" id="searchOrderId" class="form-control" placeholder="ORD-...">
              </div>
              <div class="col-md-3">
                <label class="form-label fw-semibold">T√¨m theo username</label>
                <input type="text" id="searchUsername" class="form-control" placeholder="Nh·∫≠p username">
              </div>
              <div class="col-md-2">
                <label class="form-label fw-semibold">Tr·∫°ng th√°i</label>
                <select id="filterStatus" class="form-select">
                  <option value="">T·∫•t c·∫£</option>
                  <option value="chua-xu-ly">Ch∆∞a x·ª≠ l√Ω</option>
                  <option value="dang-giao">ƒêang giao</option>
                  <option value="hoan-thanh">Ho√†n th√†nh</option>
                  <option value="da-huy">ƒê√£ h·ªßy</option>
                </select>
              </div>
              <div class="col-md-2">
                <button id="btnFilter" class="btn btn-primary w-100">
                  <i class="fa fa-filter me-2"></i>L·ªçc
                </button>
              </div>
              <div class="col-md-2">
                <button id="btnReset" class="btn btn-outline-secondary w-100">
                  <i class="fa fa-redo me-2"></i>ƒê·∫∑t l·∫°i
                </button>
              </div>
            </div>
          </div>

          <!-- Th·ªëng k√™ nhanh -->
          <div class="row mb-4">
            <div class="col-md-3">
              <div class="bg-warning bg-opacity-25 p-3 rounded text-center">
                <h5 class="mb-0" id="countChuaXuLy">0</h5>
                <small>Ch∆∞a x·ª≠ l√Ω</small>
              </div>
            </div>
            <div class="col-md-3">
              <div class="bg-info bg-opacity-25 p-3 rounded text-center">
                <h5 class="mb-0" id="countDangGiao">0</h5>
                <small>ƒêang giao</small>
              </div>
            </div>
            <div class="col-md-3">
              <div class="bg-success bg-opacity-25 p-3 rounded text-center">
                <h5 class="mb-0" id="countHoanThanh">0</h5>
                <small>Ho√†n th√†nh</small>
              </div>
            </div>
            <div class="col-md-3">
              <div class="bg-danger bg-opacity-25 p-3 rounded text-center">
                <h5 class="mb-0" id="countDaHuy">0</h5>
                <small>ƒê√£ h·ªßy</small>
              </div>
            </div>
          </div>

          <table class="table table-bordered table-striped align-middle text-center">
            <thead class="table-success">
              <tr>
                <th>STT</th>
                <th>M√£ ƒë∆°n</th>
                <th>T√†i kho·∫£n</th>
                <th>H·ªç t√™n</th>
                <th>Ng√†y ƒë·∫∑t</th>
                <th>T√¨nh tr·∫°ng</th>
                <th>ƒê·ªãa ch·ªâ</th>
                <th>T·ªïng ti·ªÅn</th>
                <th>Chi ti·∫øt</th>
              </tr>
            </thead>
            <tbody id="orderTable"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

<script>
  let allOrders = JSON.parse(localStorage.getItem("orders")) || [];
  let filteredOrders = [...allOrders];
  const table = document.getElementById("orderTable");

  // Render b·∫£ng ƒë∆°n h√†ng
  const renderOrders = (ordersToRender = filteredOrders) => {
    if (ordersToRender.length === 0) {
      table.innerHTML = `<tr><td colspan="9" class="text-center text-muted">Ch∆∞a c√≥ ƒë∆°n h√†ng n√†o</td></tr>`;
      return;
    }

    table.innerHTML = ordersToRender.map((order, index) => {
      const username = order.username || order.customer?.email || order.customer?.phone || "Kh√¥ng r√µ";
      const customerName = order.customer?.name || "Kh√¥ng c√≥ th√¥ng tin";
      const totalAmount = order.totals?.total || order.total || 0;
      
      return `
        <tr>
          <td>${index + 1}</td>
          <td><strong>${order.id}</strong></td>
          <td><span class="username-display">${username}</span></td>
          <td>${customerName}</td>
          <td>${formatDate(order.date)}</td>
          <td>${getStatusBadge(order.status)}</td>
          <td>${order.customer?.address || "Kh√¥ng c√≥ ƒë·ªãa ch·ªâ"}</td>
          <td><strong class="text-primary">${totalAmount.toLocaleString('vi-VN')}‚Ç´</strong></td>
          <td><a href="chitietdonhang.html?id=${order.id}" class="btn-view">Xem</a></td>
        </tr>
      `;
    }).join("");
  };

  // Format ng√†y th√°ng
  const formatDate = (dateString) => {
    if (!dateString) return "Kh√¥ng r√µ";
    const date = new Date(dateString);
    if (isNaN(date)) return dateString;
    return date.toLocaleDateString('vi-VN');
  };

  // Convert status sang badge
  const getStatusBadge = (status) => {
    const statusMap = {
      'chua-xu-ly': { text: 'Ch∆∞a x·ª≠ l√Ω', class: 'status-chua-xu-ly' },
      'dang-giao': { text: 'ƒêang giao', class: 'status-dang-giao' },
      'hoan-thanh': { text: 'Ho√†n th√†nh', class: 'status-hoan-thanh' },
      'da-huy': { text: 'ƒê√£ h·ªßy', class: 'status-da-huy' }
    };
    const statusInfo = statusMap[status] || { text: 'Kh√¥ng x√°c ƒë·ªãnh', class: '' };
    return `<span class="status-badge ${statusInfo.class}">${statusInfo.text}</span>`;
  };

  // Th·ªëng k√™ s·ªë l∆∞·ª£ng ƒë∆°n theo tr·∫°ng th√°i
  const updateStatistics = (orders = filteredOrders) => {
    const stats = {
      'chua-xu-ly': 0,
      'dang-giao': 0,
      'hoan-thanh': 0,
      'da-huy': 0
    };

    orders.forEach(order => {
      if (stats.hasOwnProperty(order.status)) {
        stats[order.status]++;
      }
    });

    document.getElementById('countChuaXuLy').textContent = stats['chua-xu-ly'];
    document.getElementById('countDangGiao').textContent = stats['dang-giao'];
    document.getElementById('countHoanThanh').textContent = stats['hoan-thanh'];
    document.getElementById('countDaHuy').textContent = stats['da-huy'];
  };

  // B·ªô l·ªçc
  const applyFilter = () => {
    const searchOrderId = document.getElementById('searchOrderId').value.toLowerCase().trim();
    const searchUsername = document.getElementById('searchUsername').value.toLowerCase().trim();
    const filterStatus = document.getElementById('filterStatus').value;

    filteredOrders = allOrders.filter(order => {
      const matchOrderId = !searchOrderId || (order.id || '').toLowerCase().includes(searchOrderId);
      
      const username = (order.username || order.customer?.email || order.customer?.phone || '').toLowerCase();
      const matchUsername = !searchUsername || username.includes(searchUsername);
      
      const matchStatus = !filterStatus || order.status === filterStatus;

      return matchOrderId && matchUsername && matchStatus;
    });

    renderOrders(filteredOrders);
    updateStatistics(filteredOrders);
  };

  // Reset b·ªô l·ªçc
  const resetFilter = () => {
    document.getElementById('searchOrderId').value = '';
    document.getElementById('searchUsername').value = '';
    document.getElementById('filterStatus').value = '';
    
    filteredOrders = [...allOrders];
    renderOrders(filteredOrders);
    updateStatistics(filteredOrders);
  };

  // Event listeners
  document.getElementById('btnFilter').addEventListener('click', applyFilter);
  document.getElementById('btnReset').addEventListener('click', resetFilter);

  // Kh·ªüi t·∫°o
  renderOrders();
  updateStatistics();
  
  console.log('üì¶ Loaded orders:', allOrders);
</script>
</body>
</html>