<!-- File: quanlydonhang.html -->
<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Quáº£n lÃ½ ÄÆ¡n hÃ ng - Thá»©c Store</title>

  <!-- Bootstrap & Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
  <link rel="stylesheet" href="../css/admin-shared.css">

  <style>
    body { background-color: #f3f8f3; font-family: "Open Sans", sans-serif; }
    .content-area {
      background: #fff; border-radius: 1rem;
      box-shadow: 0 3px 8px rgba(0,0,0,0.05);
      padding: 2rem; min-height: 75vh;
    }
    .btn-view {
      background: #2d6a4f; color: #fff; border: none;
      padding: 4px 10px; border-radius: 4px; text-decoration: none;
    }
    .btn-view:hover { background: #1b4332; color: #fff; }
    
    .status-badge {
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 0.85rem;
      font-weight: 600;
    }
    .status-chua-xu-ly { background: #fff3cd; color: #856404; }
    .status-dang-giao { background: #cfe2ff; color: #084298; }
    .status-hoan-thanh { background: #d1e7dd; color: #0f5132; }
    .status-da-huy { background: #f8d7da; color: #842029; }

    .username-display {
      font-weight: 600;
      color: #2d6a4f;
    }
    
    .filter-section {
      background: #f8f9fa;
      padding: 1rem;
      border-radius: 8px;
      margin-bottom: 1.5rem;
    }
  </style>
</head>

<body>
  <div class="container-fluid py-4">
    <div class="admin-banner">
      <h1>Thá»©c Store Admin</h1>
      <p>Quáº£n lÃ½ ÄÆ¡n hÃ ng</p>
    </div>

    <div class="row">
      <div class="col-lg-3 mb-4">
        <div class="sidebar">
          <h5>ğŸ“‹ Menu quáº£n lÃ½</h5>
          <a href="quanlysanpham.html" class="menu-item"><span class="emoji">ğŸ“˜</span> Quáº£n lÃ½ Sáº£n pháº©m</a>
          <a href="quanlydonhang.html" class="menu-item active"><span class="emoji">ğŸ§¾</span> Quáº£n lÃ½ ÄÆ¡n hÃ ng</a>
          <a href="user.html" class="menu-item"><span class="emoji">ğŸ‘¤</span> Quáº£n lÃ½ NgÆ°á»i dÃ¹ng</a>
          <a href="stock.html" class="menu-item"><span class="emoji">ğŸ“¦</span> Quáº£n lÃ½ Kho</a>
          <a href="pricing.html" class="menu-item"><span class="emoji">ğŸ’²</span> Quáº£n lÃ½ GiÃ¡</a>
          <a href="import.html" class="menu-item"><span class="emoji">ğŸšš</span> Nháº­p hÃ ng</a>
        </div>
      </div>

      <div class="col-lg-9">
        <div class="content-area">
          <div class="d-flex justify-content-between align-items-center mb-4">
            <h4 class="text-success fw-bold">Quáº£n lÃ½ ÄÆ¡n hÃ ng</h4>
            <button class="btn btn-sm btn-success">ÄÄƒng xuáº¥t</button>
          </div>

          <!-- Bá»™ lá»c -->
          <div class="filter-section">
            <div class="row g-3 align-items-end">
              <div class="col-md-3">
                <label class="form-label fw-semibold">TÃ¬m theo mÃ£ Ä‘Æ¡n</label>
                <input type="text" id="searchOrderId" class="form-control" placeholder="ORD-...">
              </div>
              <div class="col-md-3">
                <label class="form-label fw-semibold">TÃ¬m theo username</label>
                <input type="text" id="searchUsername" class="form-control" placeholder="Nháº­p username">
              </div>
              <div class="col-md-2">
                <label class="form-label fw-semibold">Tráº¡ng thÃ¡i</label>
                <select id="filterStatus" class="form-select">
                  <option value="">Táº¥t cáº£</option>
                  <option value="chua-xu-ly">ChÆ°a xá»­ lÃ½</option>
                  <option value="dang-giao">Äang giao</option>
                  <option value="hoan-thanh">HoÃ n thÃ nh</option>
                  <option value="da-huy">ÄÃ£ há»§y</option>
                </select>
              </div>
              <div class="col-md-2">
                <button id="btnFilter" class="btn btn-primary w-100">
                  <i class="fa fa-filter me-2"></i>Lá»c
                </button>
              </div>
              <div class="col-md-2">
                <button id="btnReset" class="btn btn-outline-secondary w-100">
                  <i class="fa fa-redo me-2"></i>Äáº·t láº¡i
                </button>
              </div>
            </div>
          </div>

          <!-- Thá»‘ng kÃª nhanh -->
          <div class="row mb-4">
            <div class="col-md-3">
              <div class="bg-warning bg-opacity-25 p-3 rounded text-center">
                <h5 class="mb-0" id="countChuaXuLy">0</h5>
                <small>ChÆ°a xá»­ lÃ½</small>
              </div>
            </div>
            <div class="col-md-3">
              <div class="bg-info bg-opacity-25 p-3 rounded text-center">
                <h5 class="mb-0" id="countDangGiao">0</h5>
                <small>Äang giao</small>
              </div>
            </div>
            <div class="col-md-3">
              <div class="bg-success bg-opacity-25 p-3 rounded text-center">
                <h5 class="mb-0" id="countHoanThanh">0</h5>
                <small>HoÃ n thÃ nh</small>
              </div>
            </div>
            <div class="col-md-3">
              <div class="bg-danger bg-opacity-25 p-3 rounded text-center">
                <h5 class="mb-0" id="countDaHuy">0</h5>
                <small>ÄÃ£ há»§y</small>
              </div>
            </div>
          </div>

          <table class="table table-bordered table-striped align-middle text-center">
            <thead class="table-success">
              <tr>
                <th>STT</th>
                <th>MÃ£ Ä‘Æ¡n</th>
                <th>TÃ i khoáº£n</th>
                <th>Há» tÃªn</th>
                <th>NgÃ y Ä‘áº·t</th>
                <th>TÃ¬nh tráº¡ng</th>
                <th>Äá»‹a chá»‰</th>
                <th>Tá»•ng tiá»n</th>
                <th>Chi tiáº¿t</th>
              </tr>
            </thead>
            <tbody id="orderTable"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

<script>
  let allOrders = JSON.parse(localStorage.getItem("orders")) || [];
  let filteredOrders = [...allOrders];
  const table = document.getElementById("orderTable");

  // Render báº£ng Ä‘Æ¡n hÃ ng
  const renderOrders = (ordersToRender = filteredOrders) => {
    if (ordersToRender.length === 0) {
      table.innerHTML = `<tr><td colspan="9" class="text-center text-muted">ChÆ°a cÃ³ Ä‘Æ¡n hÃ ng nÃ o</td></tr>`;
      return;
    }

    table.innerHTML = ordersToRender.map((order, index) => {
      const username = order.username || order.customer?.email || order.customer?.phone || "KhÃ´ng rÃµ";
      const customerName = order.customer?.name || "KhÃ´ng cÃ³ thÃ´ng tin";
      const totalAmount = order.totals?.total || order.total || 0;
      
      return `
        <tr>
          <td>${index + 1}</td>
          <td><strong>${order.id}</strong></td>
          <td><span class="username-display">${username}</span></td>
          <td>${customerName}</td>
          <td>${formatDate(order.date)}</td>
          <td>${getStatusBadge(order.status)}</td>
          <td>${order.customer?.address || "KhÃ´ng cÃ³ Ä‘á»‹a chá»‰"}</td>
          <td><strong class="text-primary">${totalAmount.toLocaleString('vi-VN')}â‚«</strong></td>
          <td><a href="chitietdonhang.html?id=${order.id}" class="btn-view">Xem</a></td>
        </tr>
      `;
    }).join("");
  };

  // Format ngÃ y thÃ¡ng
  const formatDate = (dateString) => {
    if (!dateString) return "KhÃ´ng rÃµ";
    const date = new Date(dateString);
    if (isNaN(date)) return dateString;
    return date.toLocaleString('vi-VN');
  };

  // Convert status sang badge
  const getStatusBadge = (status) => {
    const statusMap = {
      'chua-xu-ly': { text: 'ChÆ°a xá»­ lÃ½', class: 'status-chua-xu-ly' },
      'dang-giao': { text: 'Äang giao', class: 'status-dang-giao' },
      'hoan-thanh': { text: 'HoÃ n thÃ nh', class: 'status-hoan-thanh' },
      'da-huy': { text: 'ÄÃ£ há»§y', class: 'status-da-huy' }
    };
    const statusInfo = statusMap[status] || { text: 'KhÃ´ng xÃ¡c Ä‘á»‹nh', class: '' };
    return `<span class="status-badge ${statusInfo.class}">${statusInfo.text}</span>`;
  };

  // Thá»‘ng kÃª sá»‘ lÆ°á»£ng Ä‘Æ¡n theo tráº¡ng thÃ¡i
  const updateStatistics = (orders = filteredOrders) => {
    const stats = {
      'chua-xu-ly': 0,
      'dang-giao': 0,
      'hoan-thanh': 0,
      'da-huy': 0
    };

    orders.forEach(order => {
      if (stats.hasOwnProperty(order.status)) {
        stats[order.status]++;
      }
    });

    document.getElementById('countChuaXuLy').textContent = stats['chua-xu-ly'];
    document.getElementById('countDangGiao').textContent = stats['dang-giao'];
    document.getElementById('countHoanThanh').textContent = stats['hoan-thanh'];
    document.getElementById('countDaHuy').textContent = stats['da-huy'];
  };

  // Bá»™ lá»c
  const applyFilter = () => {
    const searchOrderId = document.getElementById('searchOrderId').value.toLowerCase().trim();
    const searchUsername = document.getElementById('searchUsername').value.toLowerCase().trim();
    const filterStatus = document.getElementById('filterStatus').value;

    filteredOrders = allOrders.filter(order => {
      const matchOrderId = !searchOrderId || (order.id || '').toLowerCase().includes(searchOrderId);
      
      const username = (order.username || order.customer?.email || order.customer?.phone || '').toLowerCase();
      const matchUsername = !searchUsername || username.includes(searchUsername);
      
      const matchStatus = !filterStatus || order.status === filterStatus;

      return matchOrderId && matchUsername && matchStatus;
    });

    renderOrders(filteredOrders);
    updateStatistics(filteredOrders);
  };

  // Reset bá»™ lá»c
  const resetFilter = () => {
    document.getElementById('searchOrderId').value = '';
    document.getElementById('searchUsername').value = '';
    document.getElementById('filterStatus').value = '';
    
    filteredOrders = [...allOrders];
    renderOrders(filteredOrders);
    updateStatistics(filteredOrders);
  };

  // Event listeners
  document.getElementById('btnFilter').addEventListener('click', applyFilter);
  document.getElementById('btnReset').addEventListener('click', resetFilter);

  // Khá»Ÿi táº¡o
  renderOrders();
  updateStatistics();
  
  console.log('ğŸ“¦ Loaded orders:', allOrders);
</script>
</body>
</html>
