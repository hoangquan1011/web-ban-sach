<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Admin - Nh·∫≠p h√†ng | Th·ª©c Store</title>

  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
  <link rel="stylesheet" href="../css/admin-shared.css">

  <style>
    body { background-color:#f3f8f3; font-family: "Open Sans", sans-serif; }
    .content-area { background:#fff; border-radius:1rem; box-shadow:0 3px 8px rgba(0,0,0,0.04); padding:1.5rem; min-height:65vh; }
    .card { border:none; box-shadow:0 4px 16px rgba(0,0,0,0.05); border-radius:1rem; }
    .card-header { background-color:#f8fdf9; border-bottom:1px solid #e6f3ea; border-radius:1rem 1rem 0 0 !important; }
    .form-muted { font-size:.9rem; color:#6c757d; }
    .table thead { background:#f5f8f6; font-weight:600; color:#2d6a4f; }
    .combo-hint { font-size:.85rem; color:#6c757d; margin-top:4px; }
  </style>
</head>
<body>
  <div class="container-fluid py-4">
    <div class="admin-banner">
      <div class="text-center">
        <h1 class="h2 fw-bold">Th·ª©c Store Admin</h1>
        <div class="small">Qu·∫£n l√Ω nh·∫≠p h√†ng ‚Äì Ghi nh·∫≠n t·ªìn kho</div>
      </div>
    </div>

    <div class="row g-4">
      <!-- Sidebar -->
      <div class="col-lg-3">
        <div class="sidebar">
          <h5>üìã Menu qu·∫£n l√Ω</h5>
          <a href="quanlysanpham.html" class="menu-item"><span class="emoji">üìò</span> Qu·∫£n l√Ω S·∫£n ph·∫©m</a>
          <a href="quanlydonhang.html" class="menu-item"><span class="emoji">üßæ</span> Qu·∫£n l√Ω ƒê∆°n h√†ng</a>
          <a href="user.html" class="menu-item"><span class="emoji">üë§</span> Qu·∫£n l√Ω Ng∆∞·ªùi d√πng</a>
          <a href="stock.html" class="menu-item"><span class="emoji">üì¶</span> Qu·∫£n l√Ω Kho</a>
          <a href="pricing.html" class="menu-item"><span class="emoji">üí≤</span> Qu·∫£n l√Ω Gi√°</a>
          <a href="import.html" class="menu-item active"><span class="emoji">üöö</span> Nh·∫≠p h√†ng</a>
        </div>
      </div>

      <!-- Content -->
      <div class="col-lg-9">
        <div class="content-area">
          <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
              <h5 class="mb-0 text-success"><i class="fa-solid fa-file-circle-plus me-2"></i>Phi·∫øu nh·∫≠p m·ªõi</h5>
              <span class="form-muted"></span>
            </div>
            <div class="card-body">
              <div class="row g-3">
                <div class="col-md-4">
                  <label class="form-label">M√£ phi·∫øu</label>
                  <input id="receiptCode" class="form-control" placeholder="PN-2025-001" disabled>
                </div>
                <div class="col-md-4">
                  <label class="form-label">Ng√†y nh·∫≠p</label>
                  <input type="date" id="receiptDate" class="form-control">
                </div>
                <div class="col-md-4">
                  <label class="form-label">Nh√† cung c·∫•p</label>
                  <input type="text" id="supplierInput" class="form-control" placeholder="Nh·∫≠p t√™n nh√† cung c·∫•p...">
                </div>
                <div class="col-md-8">
                  <label class="form-label">S·∫£n ph·∫©m (t·ª´ danh s√°ch Qu·∫£n l√Ω s·∫£n ph·∫©m)</label>
                  <input id="productInput" class="form-control" list="productSuggestions" placeholder="Nh·∫≠p m√£ ho·∫∑c t√™n s·∫£n ph·∫©m...">
                  <datalist id="productSuggestions">
                    <option value="KN001 ‚Äî GOOD ENERGY - NƒÇNG L∆Ø·ª¢NG T·ªêT"></option>
                    <option value="KN002 ‚Äî NGH·ªÜ THU·∫¨T T∆Ø DUY LOGIC"></option>
                    <option value="KN003 ‚Äî K·ª∏ NƒÇNG T∆Ø DUY TH·ª∞C CHI·∫æN"></option>
                    <option value="TN001 ‚Äî THI√äN NHI√äN - T·∫†I SAO CH√öNG TA C·∫¶N THI√äN NHI√äN XANH T∆Ø∆†I?"></option>
                    <option value="TN002 ‚Äî G·ª¢I M·ªû TR√ç T∆Ø·ªûNG T∆Ø·ª¢NG - N·ªñI BU·ªíN C·ª¶A C√ÇY √çCH K·ª∂"></option>
                    <option value="TN003 ‚Äî R√àN TR√ç TH√îNG MINH - T·∫¨P 3"></option>
                    <option value="VN001 ‚Äî RU·ªíI TR√ÇU (T√ÅI B·∫¢N NƒÇM 2018)"></option>
                    <option value="VH002 ‚Äî VƒÇN H·ªåC KINH ƒêI·ªÇN - L·ªÄ TH√ìI TH·ªä TH√ÄNH"></option>
                    <option value="VH003 ‚Äî VƒÇN H·ªåC KINH ƒêI·ªÇN - CH√ÇN DUNG M·ªòT CU·ªòC H√îN NH√ÇN"></option>
                    <option value="KT001 ‚Äî THE LITTLE BOOK - ƒê·∫¶U T∆Ø THEO CHI·∫æN L∆Ø·ª¢C PH√íNG TH·ª¶"></option>
                    <option value="KT002 ‚Äî T∆Ø DUY ƒê·∫¶U T∆Ø - TI·ªÄN ƒê·∫∫ RA TI·ªÄN"></option>
                    <option value="KT003 ‚Äî TI·ªÄN ƒê·∫∫ RA TI·ªÄN - ƒê·∫¶U T∆Ø T√ÄI CH√çNH TH√îNG MINH"></option>
                    <option value="GK001 ‚Äî TUY·ªÇN T·∫¨P B√ÄI VƒÇN NGH·ªä LU·∫¨N X√É H·ªòI CH·ªåN L·ªåC"></option>
                    <option value="GK002 ‚Äî LUY·ªÜN THI V√ÄO 10 NG·ªÆ VƒÇN - CHINH PH·ª§C B√ÄI NGH·ªä LU·∫¨N"></option>
                    <option value="GK003 ‚Äî TAKENOTE NG·ªÆ PH√ÅP TR·ªåNG ƒêI·ªÇM TI·∫æNG ANH THCS"></option>
                  </datalist>
                  <div class="combo-hint">G√µ m√£ ho·∫∑c t√™n ƒë·ªÉ hi·ªán g·ª£i √Ω ngay l·∫≠p t·ª©c.</div>
                </div>
                <div class="col-md-3">
                  <label class="form-label">S·ªë l∆∞·ª£ng</label>
                  <input type="number" id="quantityInput" class="form-control" min="1" placeholder="VD: 50">
                </div>
                <div class="col-md-3">
                  <label class="form-label">Gi√° nh·∫≠p (VND)</label>
                  <input type="number" id="priceInput" class="form-control" min="0" step="1000" placeholder="VD: 85.000">
                </div>
                <div class="col-md-6">
                  <label class="form-label">T·ªïng ti·ªÅn d·ª± ki·∫øn (t·∫•t c·∫£ s√°ch ƒë√£ th√™m)</label>
                  <input type="text" id="totalPreview" class="form-control" placeholder="Th√™m s·∫£n ph·∫©m ƒë·ªÉ t·ª± t√≠nh" disabled>
                  <div class="combo-hint">M·ªói l·∫ßn th√™m s√°ch v√†o danh s√°ch t·∫°m, h·ªá th·ªëng s·∫Ω t·ª± c·ªông t·ªïng.</div>
                </div>
                <div class="col-12">
                  <div class="d-flex flex-wrap align-items-center gap-2 mt-2">
                    <button type="button" id="addItemBtn" class="btn btn-outline-success">
                      <i class="fa fa-plus me-1"></i>Th√™m v√†o danh s√°ch t·∫°m
                    </button>
                  
                  </div>
                  <div class="table-responsive mt-3">
                    <table class="table table-sm table-hover align-middle mb-0">
                      <thead>
                        <tr>
                          <th>#</th>
                          <th>M√£</th>
                          <th>S·∫£n ph·∫©m</th>
                          <th class="text-center">SL</th>
                          <th class="text-end">Gi√° nh·∫≠p</th>
                          <th class="text-end">Th√†nh ti·ªÅn</th>
                          <th></th>
                        </tr>
                      </thead>
                      <tbody id="currentItemsTable">
                        <tr>
                          <td colspan="7" class="text-center text-muted">Ch∆∞a c√≥ s·∫£n ph·∫©m n√†o trong phi·∫øu.</td>
                        </tr>
                      </tbody>
                    </table>
                  </div>
                </div>
                <div class="col-md-12">
                  <label class="form-label">Ghi ch√∫</label>
                  <textarea id="noteInput" class="form-control" rows="2" placeholder="Ghi ch√∫ n·ªôi b·ªô, v√≠ d·ª•: nh·∫≠p th·ª≠ nghi·ªám..."></textarea>
                </div>
              </div>
              <div class="text-end mt-4">
                <button type="button" id="resetFormBtn" class="btn btn-outline-secondary me-2"><i class="fa-solid fa-arrows-rotate me-1"></i>L√†m m·ªõi</button>
                <button type="button" id="saveReceiptBtn" class="btn btn-success"><i class="fa-solid fa-floppy-disk me-1"></i>L∆∞u phi·∫øu</button>
              </div>
            </div>
          </div>

          <div class="card">
            <div class="card-header d-flex flex-wrap gap-2 justify-content-between align-items-center">
              <h5 class="mb-0 text-success"><i class="fa-solid fa-clipboard-list me-2"></i>Danh s√°ch phi·∫øu g·∫ßn ƒë√¢y</h5>
              <div class="d-flex flex-wrap gap-2">
                <input type="text" class="form-control form-control-sm" placeholder="üîç T√¨m theo m√£ phi·∫øu...">
              </div>
            </div>
            <div class="card-body">
              <div class="table-responsive">
                <table class="table table-hover align-middle">
                  <thead>
                    <tr>
                      <th>M√£ phi·∫øu</th>
                      <th>Ng√†y nh·∫≠p</th>
                      <th>S·∫£n ph·∫©m</th>
                      <th>S·ªë l∆∞·ª£ng</th>
                      <th>T·ªïng ti·ªÅn</th>
                      <th>Ghi ch√∫</th>
                    </tr>
                  </thead>
                  <tbody id="receiptTable">
                  </tbody>
                </table>
              </div>
              <p class="form-muted mb-0"></p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const STORAGE_KEY = 'importDemoReceipts';
      const DEFAULT_RECEIPTS = [
        {
          code: 'PN-2025-001',
          date: '2025-01-08',
          supplier: 'NXB Kim ƒê·ªìng',
          note: 'B·ªï sung ƒë·ª£t T·∫øt',
          items: [
            { code: 'TN001', name: 'THI√äN NHI√äN - T·∫†I SAO CH√öNG TA C·∫¶N THI√äN NHI√äN XANH T∆Ø∆†I?', qty: 60, price: 52000 },
            { code: 'TN002', name: 'G·ª¢I M·ªû TR√ç T∆Ø·ªûNG T∆Ø·ª¢NG - N·ªñI BU·ªíN C·ª¶A C√ÇY √çCH K·ª∂', qty: 40, price: 28000 },
            { code: 'TN003', name: 'R√àN TR√ç TH√îNG MINH - T·∫¨P 3', qty: 20, price: 24000 }
          ]
        },
        {
          code: 'PN-2025-002',
          date: '2025-01-11',
          supplier: 'NXB Tr·∫ª',
          note: 'Ch·ªù x√°c nh·∫≠n gi√°',
          items: [
            { code: 'KN001', name: 'GOOD ENERGY - NƒÇNG L∆Ø·ª¢NG T·ªêT', qty: 50, price: 85000 },
            { code: 'KN002', name: 'NGH·ªÜ THU·∫¨T T∆Ø DUY LOGIC', qty: 30, price: 126000 }
          ]
        },
        {
          code: 'PN-2025-003',
          date: '2025-01-15',
          supplier: 'NXB Th·∫ø Gi·ªõi',
          note: 'ƒê√£ nh·∫≠p kho ch√≠nh',
          items: [
            { code: 'KT001', name: 'THE LITTLE BOOK - ƒê·∫¶U T∆Ø THEO CHI·∫æN L∆Ø·ª¢C PH√íNG TH·ª¶', qty: 100, price: 120000 }
          ]
        }
      ];

      const refs = {
        code: document.getElementById('receiptCode'),
        date: document.getElementById('receiptDate'),
        supplier: document.getElementById('supplierInput'),
        product: document.getElementById('productInput'),
        qty: document.getElementById('quantityInput'),
        price: document.getElementById('priceInput'),
        totalPreview: document.getElementById('totalPreview'),
        note: document.getElementById('noteInput'),
        table: document.getElementById('receiptTable'),
        resetBtn: document.getElementById('resetFormBtn'),
        saveBtn: document.getElementById('saveReceiptBtn'),
        addItemBtn: document.getElementById('addItemBtn'),
        itemsTable: document.getElementById('currentItemsTable')
      };

      let receipts = [];
      let currentItems = [];

      const formatCurrency = (value) =>
        Number(value || 0).toLocaleString('vi-VN', { style: 'currency', currency: 'VND' }).replace('‚Ç´', 'ƒë');

      const formatDate = (value) => {
        if (!value) return '‚Äî';
        const dt = new Date(value);
        return Number.isNaN(dt.getTime()) ? value : dt.toLocaleDateString('vi-VN');
      };

      const getItemTotal = (item = {}) => {
        const qty = Number(item.qty || 0);
        const price = Number(item.price || 0);
        return qty > 0 && price >= 0 ? qty * price : 0;
      };

      const getReceiptItems = (receipt = {}) =>
        Array.isArray(receipt.items) && receipt.items.length ? receipt.items : [];

      const calculateReceiptTotal = (receipt = {}) => {
        const items = getReceiptItems(receipt);
        if (items.length) {
          return items.reduce((sum, item) => sum + getItemTotal(item), 0);
        }
        return Number(receipt.total) || 0;
      };

      const calculateReceiptQty = (receipt = {}) => {
        const items = getReceiptItems(receipt);
        if (items.length) {
          return items.reduce((sum, item) => sum + Number(item.qty || 0), 0);
        }
        return Number(receipt.qty) || 0;
      };

      const buildReceiptProductDisplay = (receipt = {}) => {
        const items = getReceiptItems(receipt);
        if (!items.length) {
          return receipt.product || '‚Äî';
        }
        const preview = items
          .slice(0, 2)
          .map(
            (item) =>
              `<div>${item.name || item.code || 'S·∫£n ph·∫©m'} <small class="text-muted">(x${item.qty || 0})</small></div>`
          )
          .join('');
        const remain =
          items.length > 2
            ? `<div class="text-muted small">+ ${items.length - 2} s·∫£n ph·∫©m kh√°c</div>`
            : '';
        return preview + remain;
      };

      const persist = () => localStorage.setItem(STORAGE_KEY, JSON.stringify(receipts));

      const renderReceipts = () => {
        if (!refs.table) return;
        if (!receipts.length) {
          refs.table.innerHTML = '<tr><td colspan="6" class="text-center text-muted">Ch∆∞a c√≥ phi·∫øu n√†o.</td></tr>';
          return;
        }

        refs.table.innerHTML = receipts
          .map((r) => {
            const totalQty = calculateReceiptQty(r);
            const totalAmount = calculateReceiptTotal(r);
            return `
              <tr>
                <td><strong>${r.code}</strong></td>
                <td>${formatDate(r.date)}</td>
                <td>${buildReceiptProductDisplay(r)}</td>
                <td>${totalQty}</td>
                <td>${formatCurrency(totalAmount)}</td>
                <td>${r.note || '‚Äî'}</td>
              </tr>
            `;
          })
          .join('');
      };

      const loadReceipts = () => {
        const stored = JSON.parse(localStorage.getItem(STORAGE_KEY) || 'null');
        receipts = Array.isArray(stored) && stored.length ? stored : [...DEFAULT_RECEIPTS];
        renderReceipts();
      };

      const generateCode = () => {
        const now = new Date();
        return `PN-${now.getFullYear()}${String(now.getMonth() + 1).padStart(2, '0')}-${String(now.getTime()).slice(-4)}`;
      };

      const updateTempCode = () => {
        if (refs.code) refs.code.value = generateCode();
      };

      const parseProductInput = (value = '') => {
        const parts = value.split('‚Äî');
        if (parts.length >= 2) {
          return {
            code: parts[0]?.trim() || '',
            name: parts.slice(1).join('‚Äî').trim()
          };
        }
        return { code: '', name: value.trim() };
      };

      const updateTotalPreview = () => {
        if (!refs.totalPreview) return;
        const total = currentItems.reduce((sum, item) => sum + getItemTotal(item), 0);
        refs.totalPreview.value = total ? formatCurrency(total) : '';
      };

      const renderCurrentItems = () => {
        if (!refs.itemsTable) return;
        if (!currentItems.length) {
          refs.itemsTable.innerHTML =
            '<tr><td colspan="7" class="text-center text-muted">Ch∆∞a c√≥ s·∫£n ph·∫©m n√†o trong phi·∫øu.</td></tr>';
          updateTotalPreview();
          return;
        }

        refs.itemsTable.innerHTML = currentItems
          .map((item, index) => {
            return `
              <tr>
                <td>${index + 1}</td>
                <td>${item.code || '‚Äî'}</td>
                <td>${item.name || 'S·∫£n ph·∫©m'}</td>
                <td class="text-center">${item.qty}</td>
                <td class="text-end">${formatCurrency(item.price)}</td>
                <td class="text-end">${formatCurrency(getItemTotal(item))}</td>
                <td class="text-end">
                  <button type="button" class="btn btn-link text-danger p-0" data-remove-index="${index}" title="X√≥a d√≤ng n√†y">
                    <i class="fa fa-times"></i>
                  </button>
                </td>
              </tr>
            `;
          })
          .join('');
        updateTotalPreview();
      };

      const resetForm = () => {
        updateTempCode();
        if (refs.date) refs.date.value = '';
        if (refs.supplier) refs.supplier.value = '';
        if (refs.product) refs.product.value = '';
        if (refs.qty) refs.qty.value = '';
        if (refs.price) refs.price.value = '';
        if (refs.note) refs.note.value = '';
        currentItems = [];
        renderCurrentItems();
      };

      const handleAddItem = () => {
        const rawValue = refs.product?.value?.trim() || '';
        if (!rawValue) {
          alert('Vui l√≤ng nh·∫≠p m√£ ho·∫∑c t√™n s√°ch tr∆∞·ªõc.');
          return;
        }
        const qty = Number(refs.qty?.value);
        const price = Number(refs.price?.value);
        if (!qty || qty <= 0) {
          alert('S·ªë l∆∞·ª£ng ph·∫£i l·ªõn h∆°n 0.');
          return;
        }
        if (price === null || Number.isNaN(price) || price < 0) {
          alert('Gi√° nh·∫≠p kh√¥ng h·ª£p l·ªá.');
          return;
        }

        const parsed = parseProductInput(rawValue);
        currentItems.push({
          code: parsed.code,
          name: parsed.name || parsed.code || rawValue,
          qty,
          price
        });
        renderCurrentItems();
        if (refs.product) refs.product.value = '';
        if (refs.qty) refs.qty.value = '';
        if (refs.price) refs.price.value = '';
      };

      const handleSave = () => {
        if (!currentItems.length) {
          alert('Vui l√≤ng th√™m √≠t nh·∫•t m·ªôt lo·∫°i s√°ch v√†o danh s√°ch t·∫°m.');
          return;
        }

        const itemsPayload = currentItems.map((item) => ({
          code: item.code,
          name: item.name,
          qty: Number(item.qty) || 0,
          price: Number(item.price) || 0,
          total: getItemTotal(item)
        }));
        const totalQty = itemsPayload.reduce((sum, item) => sum + (item.qty || 0), 0);
        const totalAmount = itemsPayload.reduce((sum, item) => sum + (item.total || 0), 0);
        const summaryName =
          itemsPayload.length === 1
            ? `${itemsPayload[0].name} (x${itemsPayload[0].qty})`
            : `${itemsPayload[0].name} + ${itemsPayload.length - 1} SP kh√°c`;

        const newReceipt = {
          code: refs.code?.value || generateCode(),
          date: refs.date?.value || new Date().toISOString().slice(0, 10),
          supplier: refs.supplier?.value?.trim() || '',
          product: summaryName,
          items: itemsPayload,
          qty: totalQty,
          total: totalAmount,
          note: refs.note?.value?.trim() || ''
        };

        receipts.unshift(newReceipt);
        persist();
        renderReceipts();
        alert('ƒê√£ l∆∞u phi·∫øu (demo). Phi·∫øu n√†y ch·ªâ hi·ªÉn th·ªã trong danh s√°ch ph√≠a d∆∞·ªõi.');
        resetForm();
      };

      refs.resetBtn?.addEventListener('click', resetForm);
      refs.saveBtn?.addEventListener('click', handleSave);
      refs.addItemBtn?.addEventListener('click', handleAddItem);
      refs.itemsTable?.addEventListener('click', (event) => {
        const btn = event.target.closest('[data-remove-index]');
        if (!btn) return;
        const index = Number(btn.dataset.removeIndex);
        if (Number.isNaN(index)) return;
        currentItems.splice(index, 1);
        renderCurrentItems();
      });

      loadReceipts();
      resetForm();
    });
  </script>
</body>
</html>
