<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Admin - Nh·∫≠p h√†ng | Th·ª©c Store</title>

  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">

  <style>
    body { background-color:#f3f8f3; font-family: "Open Sans", sans-serif; }
  .admin-banner { background: linear-gradient(0deg, rgba(0,80,40,0.45), rgba(0,80,40,0.45)), url('../img/banner.jpg') center/cover no-repeat; height: 180px; border-radius:12px; display:flex; align-items:center; justify-content:center; color:#fff; margin-bottom:1.5rem; position:relative; }
    .sidebar { background-color:#fff; border-radius:1rem; box-shadow:0 3px 10px rgba(0,0,0,0.08); padding:1.5rem; height:100%; }
    .menu-item { display:flex; align-items:center; color:#2d6a4f; font-weight:600; text-decoration:none; margin-bottom:0.8rem; }
    .menu-item:hover { color:#40916c; transform:translateX(6px); transition:all .2s; }
    .content-area { background:#fff; border-radius:1rem; box-shadow:0 3px 8px rgba(0,0,0,0.04); padding:1.5rem; min-height:65vh; }
    .status-draft { color:#856404; background:#fff3cd; padding:4px 8px; border-radius:6px; }
    .status-completed { color:#155724; background:#d4edda; padding:4px 8px; border-radius:6px; }
    .small-input { max-width:160px; }

    /* ===== Sidebar ===== */
    .sidebar {
      background-color: #ffffff;
      border-radius: 1rem;
      box-shadow: 0 3px 10px rgba(0,0,0,0.1);
      padding: 1.5rem;
      height: 100%;
    }
    .sidebar h5 { color: #2d6a4f; font-weight: 700; margin-bottom: 1rem; }
    .menu-item { display: flex; align-items: center; color: #2d6a4f; font-weight: 600; text-decoration: none; margin-bottom: 1rem; transition: .3s; }
    .menu-item:hover { color: #40916c; transform: translateX(5px); }
    .menu-item.active { color: #1b4332; font-weight: 700; }
    .menu-item span.emoji { font-size: 1.5rem; margin-right: .75rem; }

  </style>
</head>
<body>
  <div class="container-fluid py-4">
    <div class="admin-banner">
      <div class="text-center">
        <h1 class="h2 fw-bold">Th·ª©c Store Admin</h1>
        <div class="small">Qu·∫£n l√Ω Nh·∫≠p h√†ng ‚Äî C·∫≠p nh·∫≠t t·ªìn & gi√° v·ªën</div>
      </div>
    </div>

    <div class="row g-4">
      <!-- Sidebar -->
      <div class="col-lg-3">
        <div class="sidebar">
          <h5 class="text-success">üìã Menu qu·∫£n l√Ω</h5>
          <a href="quanlysanpham.html" class="menu-item"><span class="me-2">üìò</span> Qu·∫£n l√Ω S·∫£n ph·∫©m</a>
          <a href="quanlydonhang.html" class="menu-item"><span class="me-2">üßæ</span> Qu·∫£n l√Ω ƒê∆°n h√†ng</a>
          <a href="pricing.html" class="menu-item"><span class="me-2">üí≤</span> Qu·∫£n l√Ω Gi√°</a>
          <a href="stock.html" class="menu-item"><span class="me-2">üì¶</span> Qu·∫£n l√Ω Kho</a>
          <a href="import.html" class="menu-item active"><span class="me-2">üöö</span> Nh·∫≠p h√†ng</a>

        </div>
      </div>

      <!-- Content -->
      <div class="col-lg-9">
        <div class="content-area">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h4 class="text-success m-0">Qu·∫£n l√Ω Phi·∫øu Nh·∫≠p</h4>
            <div>
              <button id="newReceipt" class="btn btn-sm btn-success"><i class="fa fa-plus me-1"></i> T·∫°o phi·∫øu m·ªõi</button>
            </div>
          </div>

          <!-- Form th√™m / s·ª≠a -->
          <div class="card mb-4">
            <div class="card-body">
              <form id="receiptForm" class="row g-3">
                <input type="hidden" id="receiptId" />
                <div class="col-md-4">
                  <label class="form-label">Ng√†y nh·∫≠p</label>
                  <input id="receiptDate" class="form-control" type="datetime-local">
                </div>
                <div class="col-md-3">
                  <label class="form-label">Tr·∫°ng th√°i</label>
                  <select id="receiptStatus" class="form-select">
                    <option value="draft">Draft (Ch∆∞a ho√†n th√†nh)</option>
                    <option value="completed">Completed (Ho√†n th√†nh)</option>
                  </select>
                </div>
                <div class="col-md-5">
                  <label class="form-label">Ghi ch√∫</label>
                  <input id="receiptNote" class="form-control" placeholder="Ghi ch√∫ ng·∫Øn">
                </div>

                <div class="col-12">
                  <h6>Chi ti·∫øt h√†ng</h6>
                  <div id="lineItems" class="mb-2 text-muted">Ch∆∞a c√≥ d√≤ng h√†ng.</div>

                  <div class="row g-2 align-items-end">
                    <div class="col-md-6">
                      <label class="form-label">S·∫£n ph·∫©m</label>
                      <select id="productSelect" class="form-select"></select>
                    </div>
                    <div class="col-md-2">
                      <label class="form-label">S·ªë l∆∞·ª£ng</label>
                      <input id="itemQty" class="form-control small-input" type="number" min="1" value="1">
                    </div>
                    <div class="col-md-2">
                      <label class="form-label">Gi√° nh·∫≠p (VND)</label>
                      <input id="itemPrice" class="form-control small-input" type="number" min="0" step="0.01" placeholder="0">
                    </div>
                    <div class="col-md-2">
                      <button id="addLineBtn" type="button" class="btn btn-success w-100">Th√™m d√≤ng</button>
                    </div>
                  </div>
                </div>

                <div class="col-12 text-end">
                  <button id="saveReceiptBtn" type="button" class="btn btn-primary"><i class="fa fa-save me-1"></i> L∆∞u phi·∫øu</button>
                  <button id="resetReceiptBtn" type="button" class="btn btn-secondary">ƒê·∫∑t l·∫°i</button>
                </div>
              </form>
            </div>
          </div>

          <!-- Danh s√°ch phi·∫øu -->
          <div>
            <div class="d-flex mb-2">
              <input id="qReceipts" class="form-control me-2" placeholder="T√¨m theo ID, ng√†y, t√™n s·∫£n ph·∫©m...">
              <button id="searchReceipts" class="btn btn-outline-success me-2">T√¨m</button>
              <button id="exportReceipts" class="btn btn-outline-secondary">Xu·∫•t JSON</button>
            </div>

            <div class="table-responsive">
              <table class="table table-hover align-middle">
                <thead class="table-light">
                  <tr><th>ID</th><th>Ng√†y</th><th>Tr·∫°ng th√°i</th><th>S·ªë d√≤ng</th><th>T·ªïng SL</th><th>H√†nh ƒë·ªông</th></tr>
                </thead>
                <tbody id="receiptsTable"></tbody>
              </table>
            </div>
          </div>

        </div>
      </div>
    </div>
  </div>

  <script>
    // Shared keys and sample data
    const K = { cats:'book_cats', prods:'book_prods', receipts:'book_receipts', sales:'book_sales' };
    const SAMPLE_CATS = [{id:'cat1',name:'Ti·ªÉu thuy·∫øt'},{id:'cat2',name:'K·ªπ thu·∫≠t & CNTT'},{id:'cat3',name:'Thi·∫øu nhi'}];
    const SAMPLE_PRODS = [
      { id:'p1', title:'S√°ch Ti·ªÉu thuy·∫øt A', categoryId:'cat1', cost:120000, stock:10, threshold:5, initialStock:10, productProfit:null },
      { id:'p2', title:'L·∫≠p tr√¨nh JS', categoryId:'cat2', cost:220000, stock:5, threshold:3, initialStock:5, productProfit:null },
      { id:'p3', title:'Truy·ªán Thi·∫øu Nhi B', categoryId:'cat3', cost:80000, stock:15, threshold:6, initialStock:15, productProfit:null }
    ];

    function ensureData(){
      if (!localStorage.getItem(K.cats)) localStorage.setItem(K.cats, JSON.stringify(SAMPLE_CATS));
      if (!localStorage.getItem(K.prods)) localStorage.setItem(K.prods, JSON.stringify(SAMPLE_PRODS));
      if (!localStorage.getItem(K.receipts)) localStorage.setItem(K.receipts, JSON.stringify([]));
      if (!localStorage.getItem(K.sales)) localStorage.setItem(K.sales, JSON.stringify([]));
    }
    ensureData();
    const $ = s => document.querySelector(s);
    const $$ = s => Array.from(document.querySelectorAll(s));

    // Elements
    const productSelect = $('#productSelect');
    const itemQty = $('#itemQty');
    const itemPrice = $('#itemPrice');
    const addLineBtn = $('#addLineBtn');
    const lineItems = $('#lineItems');

    const receiptDate = $('#receiptDate');
    const receiptStatus = $('#receiptStatus');
    const receiptNote = $('#receiptNote');
    const saveReceiptBtn = $('#saveReceiptBtn');
    const resetReceiptBtn = $('#resetReceiptBtn');
    const receiptsTable = $('#receiptsTable');
    const qReceipts = $('#qReceipts');
    const searchReceipts = $('#searchReceipts');
    const newReceipt = $('#newReceipt');
    const btnRefresh = $('#btnRefresh');
    const exportReceipts = $('#exportReceipts');

    let editingReceiptId = null;
    let currentLines = [];

    function read(k){ return JSON.parse(localStorage.getItem(k) || 'null'); }
    function write(k,v){ localStorage.setItem(k, JSON.stringify(v)); }

    function loadProducts(){
      const prods = read(K.prods) || [];
      productSelect.innerHTML = '';
      prods.forEach(p=>{
        const opt = document.createElement('option');
        // use m√£ s·∫£n ph·∫©m n·∫øu c√≥, fallback v·ªÅ id
        opt.value = p.ma || p.id;
        opt.textContent = `${p.title} | M√£: ${p.ma || p.id} (T·ªìn: ${p.stock})`;
        productSelect.appendChild(opt);
      });
    }

    function renderLineItems(){
      if (currentLines.length === 0) { lineItems.innerHTML = '<div class="text-muted">Ch∆∞a c√≥ d√≤ng h√†ng.</div>'; return; }
      lineItems.innerHTML = '';
      currentLines.forEach((li, idx)=>{
        const div = document.createElement('div');
        div.className = 'd-flex align-items-center gap-2 mb-2';
        div.innerHTML = `
          <div class="flex-grow-1"><strong>${li.title}</strong></div>
          <div>S·ªë l∆∞·ª£ng: <input data-idx="${idx}" class="form-control form-control-sm li-qty" style="width:90px;display:inline-block;margin-left:8px" value="${li.qty}"></div>
          <div>Gi√°: <input data-idx="${idx}" class="form-control form-control-sm li-price" style="width:120px;display:inline-block;margin-left:8px" value="${li.price}"></div>
          <div><button data-idx="${idx}" class="btn btn-sm btn-outline-danger remove-line"><i class="fa fa-trash"></i></button></div>
        `;
        lineItems.appendChild(div);
      });
      // events
      $$('.remove-line').forEach(b=> b.onclick = e => {
        const i = +e.currentTarget.dataset.idx;
        currentLines.splice(i,1); renderLineItems();
      });
      $$('.li-qty').forEach(inp => inp.onchange = e => {
        const i = +e.target.dataset.idx;
        currentLines[i].qty = Math.max(1, Math.floor(Number(e.target.value) || 1));
      });
      $$('.li-price').forEach(inp => inp.onchange = e => {
        const i = +e.target.dataset.idx;
        currentLines[i].price = Math.max(0, Number(e.target.value) || 0);
      });
    }

    addLineBtn.onclick = () => {
      const pid = productSelect.value; // this is m√£ ho·∫∑c id
      const prods = read(K.prods) || [];
      // find by id or m√£
      const p = prods.find(x=> x.id===pid || (x.ma && x.ma===pid));
      if (!p) return alert('Ch·ªçn s·∫£n ph·∫©m h·ª£p l·ªá.');
      const qty = Math.max(1, Math.floor(Number(itemQty.value) || 1));
      const price = Math.max(0, Number(itemPrice.value) || 0);
      // store productId as the m√£ (or id) selected so we can match on m√£ when applying receipt
      currentLines.push({ productId: pid, title: p.title, qty, price });
      renderLineItems();
    };

    function resetForm(){
      editingReceiptId = null;
      currentLines = [];
      receiptDate.value = new Date().toISOString().slice(0,16);
      receiptStatus.value = 'draft';
      receiptNote.value = '';
      itemQty.value = 1;
      itemPrice.value = '';
      renderLineItems();
    }

    function applyReceiptCompletion(receipt){
      const prods = read(K.prods) || [];
      let changed = false;
      receipt.lines.forEach(li => {
        // match product by id OR m√£ (ma)
        const p = prods.find(x=> x.id===li.productId || (x.ma && x.ma===li.productId));
        if (!p) return;
        const incomingQty = Number(li.qty)||0;
        const incomingPrice = Number(li.price)||0;
        if (incomingQty <= 0) return;
        const oldStock = Number(p.stock||0);
        const oldCost = Number(p.cost||0);
        const totalQty = oldStock + incomingQty;
        const newCost = totalQty > 0 ? ((oldStock * oldCost) + (incomingQty * incomingPrice)) / totalQty : incomingPrice;
        p.cost = Math.round(newCost);
        p.stock = oldStock + incomingQty;
        changed = true;
      });
      if (changed) write(K.prods, prods);
      loadProducts();
    }

    function saveReceipt(){
      const receipts = read(K.receipts) || [];
      if (currentLines.length === 0) return alert('Phi·∫øu ph·∫£i c√≥ √≠t nh·∫•t 1 d√≤ng.');
      const dateVal = receiptDate.value ? new Date(receiptDate.value).toISOString() : new Date().toISOString();
      const status = receiptStatus.value;
      if (editingReceiptId){
        const idx = receipts.findIndex(r=>r.id===editingReceiptId);
        if (idx === -1) return alert('Phi·∫øu kh√¥ng t·ªìn t·∫°i.');
        if (receipts[idx].status === 'completed') return alert('Kh√¥ng th·ªÉ s·ª≠a phi·∫øu ƒë√£ ho√†n th√†nh.');
        receipts[idx].date = dateVal;
        receipts[idx].note = receiptNote.value;
        receipts[idx].status = status;
        receipts[idx].lines = JSON.parse(JSON.stringify(currentLines));
        receipts[idx].updatedAt = new Date().toISOString();
        if (status === 'completed') applyReceiptCompletion(receipts[idx]);
        write(K.receipts, receipts);
        loadReceiptsTable();
        resetForm();
      } else {
        const id = 'R' + Date.now();
        const rec = { id, date: dateVal, status, note: receiptNote.value, lines: JSON.parse(JSON.stringify(currentLines)), createdAt: new Date().toISOString() };
        receipts.unshift(rec);
        write(K.receipts, receipts);
        if (status === 'completed') applyReceiptCompletion(rec);
        loadReceiptsTable();
        resetForm();
      }
    }

    function loadReceiptsTable(filter=''){
      const receipts = read(K.receipts) || [];
      receiptsTable.innerHTML = '';
      const f = (filter||'').toLowerCase().trim();
      receipts.forEach(r=>{
        if (f && !(r.id.toLowerCase().includes(f) || (r.note||'').toLowerCase().includes(f) || r.date.toLowerCase().includes(f) || r.lines.some(li=>li.title.toLowerCase().includes(f)))) return;
        const totalQty = r.lines.reduce((s,li)=>s + Number(li.qty||0),0);
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${r.id}</td>
          <td>${new Date(r.date).toLocaleString()}</td>
          <td>${r.status === 'completed' ? '<span class="status-completed">Ho√†n th√†nh</span>' : '<span class="status-draft">Draft</span>'}</td>
          <td>${r.lines.length}</td>
          <td>${totalQty}</td>
          <td>
            <button class="btn btn-sm btn-outline-primary view" data-id="${r.id}">Xem</button>
            ${r.status==='draft' ? `<button class="btn btn-sm btn-outline-success edit" data-id="${r.id}">S·ª≠a</button>` : ''}
            ${r.status==='draft' ? `<button class="btn btn-sm btn-success complete" data-id="${r.id}">Ho√†n th√†nh</button>` : ''}
            <button class="btn btn-sm btn-outline-danger del" data-id="${r.id}">X√≥a</button>
          </td>
        `;
        receiptsTable.appendChild(tr);
      });
      // attach events
      $$('.view').forEach(b=> b.onclick = e => viewReceipt(e.currentTarget.dataset.id));
      $$('.edit').forEach(b=> b.onclick = e => editReceipt(e.currentTarget.dataset.id));
      $$('.complete').forEach(b=> b.onclick = e => completeReceipt(e.currentTarget.dataset.id));
      $$('.del').forEach(b=> b.onclick = e => deleteReceipt(e.currentTarget.dataset.id));
    }

    function viewReceipt(id){
      const receipts = read(K.receipts) || [];
      const r = receipts.find(x=>x.id===id);
      if (!r) return alert('Kh√¥ng t√¨m th·∫•y phi·∫øu.');
      alert(`Phi·∫øu ${r.id}\nNg√†y: ${new Date(r.date).toLocaleString()}\nTr·∫°ng th√°i: ${r.status}\nGhi ch√∫: ${r.note}\n\nD√≤ng:\n` + r.lines.map(li=>`- ${li.title} | SL: ${li.qty} | Gi√° nh·∫≠p: ${li.price}`).join('\n'));
    }

    function editReceipt(id){
      const receipts = read(K.receipts) || [];
      const r = receipts.find(x=>x.id===id);
      if (!r) return alert('Kh√¥ng t√¨m th·∫•y phi·∫øu.');
      if (r.status === 'completed') return alert('Kh√¥ng th·ªÉ s·ª≠a phi·∫øu ƒë√£ ho√†n th√†nh.');
      editingReceiptId = r.id;
      receiptDate.value = new Date(r.date).toISOString().slice(0,16);
      receiptStatus.value = r.status;
      receiptNote.value = r.note || '';
      currentLines = JSON.parse(JSON.stringify(r.lines));
      renderLineItems();
      window.scrollTo({top:0,behavior:'smooth'});
    }

    function completeReceipt(id){
      if (!confirm('X√°c nh·∫≠n ho√†n th√†nh phi·∫øu? (H√†nh ƒë·ªông n√†y s·∫Ω c·∫≠p nh·∫≠t t·ªìn kho)')) return;
      const receipts = read(K.receipts) || [];
      const r = receipts.find(x=>x.id===id);
      if (!r) return alert('Kh√¥ng t√¨m th·∫•y phi·∫øu.');
      if (r.status === 'completed') return alert('Phi·∫øu ƒë√£ ho√†n th√†nh.');
      r.status = 'completed'; r.completedAt = new Date().toISOString();
      write(K.receipts, receipts);
      applyReceiptCompletion(r);
      loadReceiptsTable();
    }

    function deleteReceipt(id){
      if (!confirm('X√≥a phi·∫øu n√†y? H√†nh ƒë·ªông kh√¥ng th·ªÉ ho√†n t√°c.')) return;
      let receipts = read(K.receipts) || [];
      receipts = receipts.filter(r=>r.id!==id);
      write(K.receipts, receipts);
      loadReceiptsTable();
    }

    saveReceiptBtn.onclick = saveReceipt;
    resetReceiptBtn.onclick = resetForm;
    searchReceipts.onclick = () => loadReceiptsTable(qReceipts.value);
    newReceipt.onclick = () => { resetForm(); window.scrollTo({top:0,behavior:'smooth'}); };
    btnRefresh.onclick = () => { ensureData(); loadProducts(); loadReceiptsTable(); alert('ƒê√£ l√†m m·ªõi d·ªØ li·ªáu (t·∫£i l·∫°i m·∫´u n·∫øu thi·∫øu).'); };
    exportReceipts.onclick = () => { const r = read(K.receipts) || []; const txt = JSON.stringify(r, null, 2); const w = window.open(); w.document.write('<pre>'+txt.replace(/</g,'&lt;')+'</pre>'); };

    // init
    function init(){
      loadProducts();
      resetForm();
      loadReceiptsTable();
      receiptDate.value = new Date().toISOString().slice(0,16);
    }
    init();
  </script>
</body>
</html>