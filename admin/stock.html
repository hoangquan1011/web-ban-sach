<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Admin - Kho | Th·ª©c Store</title>

  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">

  <style>
    body { background:#f3f8f3; font-family:"Open Sans",sans-serif; }
  .admin-banner { background: linear-gradient(0deg, rgba(0,80,40,0.45), rgba(0,80,40,0.45)), url('../img/banner.jpg') center/cover no-repeat; height:180px; border-radius:12px; color:#fff; display:flex; align-items:center; justify-content:center; margin-bottom:1.5rem;}
    .sidebar { background:#fff; border-radius:1rem; padding:1.5rem; box-shadow:0 3px 10px rgba(0,0,0,0.08); }
    .menu-item{ display:flex; align-items:center; color:#2d6a4f; font-weight:600; text-decoration:none; margin-bottom:0.8rem; }
    .content-area{ background:#fff; padding:1.5rem; border-radius:1rem; box-shadow:0 3px 8px rgba(0,0,0,0.04); min-height:65vh; }
    .low { color:#d9534f; font-weight:700; }
  </style>
</head>
<body>
  <div class="container-fluid py-4">
    <div class="admin-banner">
      <div class="text-center">
        <h1 class="h2 fw-bold">Th·ª©c Store Admin</h1>
        <div class="small">Ki·ªÉm tra t·ªìn ‚Äî L·ªãch s·ª≠ Nh·∫≠p/Xu·∫•t ‚Äî C·∫£nh b√°o</div>
      </div>
    </div>

    <div class="row g-4">
      <div class="col-lg-3">
        <div class="sidebar">
          <h5 class="text-success">üìã Menu qu·∫£n l√Ω</h5>
          <a href="giao-dien-chinh-admin.html" class="menu-item"><span class="me-2">üè†</span> Trang ch·ªß Admin</a>
          <a href="stock.html" class="menu-item"><span class="me-2">üì¶</span> Qu·∫£n l√Ω Kho</a>
          <hr>
          <div class="mt-3">
            <button id="btnRefresh" class="btn btn-outline-success btn-sm">L√†m m·ªõi</button>
            <div class="text-muted small mt-2">D·ªØ li·ªáu ƒë·ªìng b·ªô qua localStorage</div>
          </div>
        </div>
      </div>

      <div class="col-lg-9">
        <div class="content-area">
          <h4 class="text-success">Qu·∫£n l√Ω S·ªë L∆∞·ª£ng T·ªìn</h4>

          <!-- Quick search by product code: show only M√£ - T√™n - T·ªìn -->
          <div class="row">
            <div class="col-12">
              <div class="card mb-3">
                <div class="card-body">
                  <h6>T√¨m theo M√£ s·∫£n ph·∫©m</h6>
                  <div class="d-flex">
                    <input id="qStock" class="form-control me-2" placeholder="T√¨m theo m√£ s·∫£n ph·∫©m...">
                    <button id="btnStockSearch" class="btn btn-outline-success">T√¨m</button>
                  </div>
                  <div id="stockSearchResult" class="mt-3"></div>
                </div>
              </div>
            </div>
          </div>

          <div class="row g-3 mt-3">
            <div class="col-md-6">
              <div class="card">
                <div class="card-body">
                  <h6>C·∫£nh b√°o s·∫Øp h·∫øt h√†ng (hi·ªán t·∫°i)</h6>
                  <div id="lowStockList" class="mt-2 text-muted"></div>
                  <button id="refreshLow" class="btn btn-warning btn-sm mt-2">L√†m m·ªõi c·∫£nh b√°o</button>
                </div>
              </div>
            </div>

            <div class="col-md-6">
              <!-- Removed: L·ªãch s·ª≠ Nh·∫≠p - Xu·∫•t, T·ªïng h·ª£p theo Lo·∫°i, M√¥ ph·ªèng B√°n h√†ng per request -->
            </div>
          </div>

        </div>
      </div>
    </div>
  </div>

  <script>
    const K = { cats:'book_cats', prods:'book_prods', receipts:'book_receipts', sales:'book_sales' };
    function ensure(){
      if (!localStorage.getItem(K.cats)) localStorage.setItem(K.cats, JSON.stringify([{id:'cat1',name:'Ti·ªÉu thuy·∫øt'},{id:'cat2',name:'K·ªπ thu·∫≠t & CNTT'},{id:'cat3',name:'Thi·∫øu nhi'}]));
      if (!localStorage.getItem(K.prods)) localStorage.setItem(K.prods, JSON.stringify([
        { id:'p1', title:'S√°ch Ti·ªÉu thuy·∫øt A', categoryId:'cat1', cost:120000, stock:10, threshold:5, initialStock:10, productProfit:null },
        { id:'p2', title:'L·∫≠p tr√¨nh JS', categoryId:'cat2', cost:220000, stock:5, threshold:3, initialStock:5, productProfit:null },
        { id:'p3', title:'Truy·ªán Thi·∫øu Nhi B', categoryId:'cat3', cost:80000, stock:15, threshold:6, initialStock:15, productProfit:null }
      ]));
      if (!localStorage.getItem(K.receipts)) localStorage.setItem(K.receipts, JSON.stringify([]));
      if (!localStorage.getItem(K.sales)) localStorage.setItem(K.sales, JSON.stringify([]));
    }
    ensure();

    const $ = s => document.querySelector(s);
    const $$ = s => Array.from(document.querySelectorAll(s));
  const lowStockList = $('#lowStockList'), refreshLow = $('#refreshLow');
    const btnRefresh = $('#btnRefresh');
    // Stock quick-search controls
    const qStock = $('#qStock'), btnStockSearch = $('#btnStockSearch'), stockSearchResult = $('#stockSearchResult');

    function read(k){ return JSON.parse(localStorage.getItem(k) || 'null'); }
    function write(k,v){ localStorage.setItem(k, JSON.stringify(v)); }

    // product selectors removed (no longer needed)

    // Quick search: look up products by code from both 'book_prods' and admin 'products'
    function renderStockSearch(filter = ''){
      const q = (filter || '').toLowerCase().trim();
      // load both sources
      const base = read(K.prods) || [];
      const adminRaw = JSON.parse(localStorage.getItem('products') || 'null') || [];
      const admin = adminRaw.map((p,i) => ({ id: p.ma || ('admin_'+i), ma: p.ma || '', title: p.ten || '', stock: Number(p.stock||0) }));
      const all = [...base.map(p=>({ id:p.id, ma: p.ma||p.id, title: p.title, stock: Number(p.stock||0)})), ...admin];
      const filtered = q ? all.filter(p => (p.ma || '').toLowerCase().includes(q)) : all;
      if (!stockSearchResult) return;
      if (filtered.length === 0) { stockSearchResult.innerHTML = '<div class="text-muted">Kh√¥ng t√¨m th·∫•y s·∫£n ph·∫©m theo m√£.</div>'; return; }
      let html = '<div class="table-responsive"><table class="table table-sm"><thead class="table-light"><tr><th>M√£</th><th>T√™n</th><th>T·ªìn</th></tr></thead><tbody>';
      filtered.forEach(p => { html += `<tr><td>${p.ma || p.id}</td><td>${p.title}</td><td>${p.stock}</td></tr>`; });
      html += '</tbody></table></div>';
      stockSearchResult.innerHTML = html;
    }

    if (btnStockSearch) btnStockSearch.onclick = () => renderStockSearch(qStock.value);
    if (qStock) qStock.addEventListener('input', e => renderStockSearch(e.target.value));

    function refreshLowStock(){
      const prods = read(K.prods) || [];
      lowStockList.innerHTML = '';
      const lows = prods.filter(p => Number(p.stock||0) <= (Number(p.threshold||5)));
      if (lows.length === 0) { lowStockList.innerHTML = '<div class="text-muted">Kh√¥ng c√≥ s·∫£n ph·∫©m s·∫Øp h·∫øt.</div>'; return; }
      const ul = document.createElement('ul');
      lows.forEach(p=>{
        const li = document.createElement('li');
        li.innerHTML = `<strong class="low">${p.title}</strong> ‚Äî T·ªìn: ${p.stock} (Ng∆∞·ª°ng: ${p.threshold})`;
        ul.appendChild(li);
      });
      lowStockList.appendChild(ul);
    }

    // Removed history/aggregation/sale simulation handlers per request

  btnRefresh.onclick = () => { ensure(); refreshLowStock(); alert('L√†m m·ªõi xong'); };

    function init(){
      refreshLowStock();
    }
    init();
  </script>
</body>
</html>