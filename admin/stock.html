<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Admin - Kho | Th·ª©c Store</title>

  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">

  <style>
    body { background:#f3f8f3; font-family:"Open Sans",sans-serif; }
  .admin-banner { background: linear-gradient(0deg, rgba(0,80,40,0.45), rgba(0,80,40,0.45)), url('../img/banner.jpg') center/cover no-repeat; height:180px; border-radius:12px; color:#fff; display:flex; align-items:center; justify-content:center; margin-bottom:1.5rem;}
    .sidebar { background:#fff; border-radius:1rem; padding:1.5rem; box-shadow:0 3px 10px rgba(0,0,0,0.08); }
    .menu-item{ display:flex; align-items:center; color:#2d6a4f; font-weight:600; text-decoration:none; margin-bottom:0.8rem; }
    .content-area{ background:#fff; padding:1.5rem; border-radius:1rem; box-shadow:0 3px 8px rgba(0,0,0,0.04); min-height:65vh; }
    .low { color:#d9534f; font-weight:700; }
  </style>
</head>
<body>
  <div class="container-fluid py-4">
    <div class="admin-banner">
      <div class="text-center">
        <h1 class="h2 fw-bold">Th·ª©c Store Admin</h1>
        <div class="small">Ki·ªÉm tra t·ªìn ‚Äî L·ªãch s·ª≠ Nh·∫≠p/Xu·∫•t ‚Äî C·∫£nh b√°o</div>
      </div>
    </div>

    <div class="row g-4">
      <div class="col-lg-3">
        <div class="sidebar">
          <h5 class="text-success">üìã Menu qu·∫£n l√Ω</h5>
          <a href="giao-dien-chinh-admin.html" class="menu-item"><span class="me-2">üè†</span> Trang ch·ªß Admin</a>
          <a href="stock.html" class="menu-item"><span class="me-2">üì¶</span> Qu·∫£n l√Ω Kho</a>
          <hr>
          <div class="mt-3">
            <button id="btnRefresh" class="btn btn-outline-success btn-sm">L√†m m·ªõi</button>
            <div class="text-muted small mt-2">D·ªØ li·ªáu ƒë·ªìng b·ªô qua localStorage</div>
          </div>
        </div>
      </div>

      <div class="col-lg-9">
        <div class="content-area">
          <h4 class="text-success">Qu·∫£n l√Ω S·ªë L∆∞·ª£ng T·ªìn</h4>

          <div class="row g-3 mt-3">
            <div class="col-md-6">
              <div class="card mb-3">
                <div class="card-body">
                  <h6>Tra c·ª©u t·ªìn t·∫°i m·ªôt th·ªùi ƒëi·ªÉm</h6>
                  <div class="d-flex gap-2">
                    <select id="prodSelect" class="form-select"></select>
                    <input id="atDate" type="datetime-local" class="form-control" />
                    <button id="computeAt" class="btn btn-success">T√≠nh t·ªìn</button>
                  </div>
                  <div id="stockAtResult" class="mt-2 text-muted"></div>
                </div>
              </div>

              <div class="card mb-3">
                <div class="card-body">
                  <h6>T·ªìn theo Lo·∫°i t·∫°i m·ªôt th·ªùi ƒëi·ªÉm</h6>
                  <div class="d-flex gap-2">
                    <select id="catAtSelect" class="form-select"></select>
                    <input id="catAtDate" type="datetime-local" class="form-control" />
                    <button id="catAtCompute" class="btn btn-success">Xem t·ªìn</button>
                  </div>
                  <div id="catAtResult" class="mt-2"></div>
                </div>
              </div>

              <div class="card">
                <div class="card-body">
                  <h6>C·∫£nh b√°o s·∫Øp h·∫øt h√†ng (hi·ªán t·∫°i)</h6>
                  <div id="lowStockList" class="mt-2 text-muted"></div>
                  <button id="refreshLow" class="btn btn-warning btn-sm mt-2">L√†m m·ªõi c·∫£nh b√°o</button>
                </div>
              </div>
            </div>

            <div class="col-md-6">
              <div class="card mb-3">
                <div class="card-body">
                  <h6>L·ªãch s·ª≠ Nh·∫≠p - Xu·∫•t (kho·∫£ng th·ªùi gian)</h6>
                  <div class="d-flex gap-2">
                    <select id="histProd" class="form-select"></select>
                    <input id="fromDate" type="date" class="form-control" />
                    <input id="toDate" type="date" class="form-control" />
                    <button id="getHist" class="btn btn-success">Xem</button>
                  </div>
                  <div id="histResult" class="mt-2"></div>
                </div>
              </div>

              <div class="card">
                <div class="card-body">
                  <h6>T·ªïng h·ª£p theo Lo·∫°i (kho·∫£ng th·ªùi gian)</h6>
                  <div class="d-flex gap-2">
                    <select id="catHistSelect" class="form-select"></select>
                    <input id="catFromDate" type="date" class="form-control" />
                    <input id="catToDate" type="date" class="form-control" />
                    <button id="catGet" class="btn btn-success">Xem</button>
                  </div>
                  <div id="catHistResult" class="mt-2"></div>
                </div>
              </div>

              <div class="card">
                <div class="card-body">
                  <h6>M√¥ ph·ªèng B√°n h√†ng (gi·∫£m t·ªìn)</h6>
                  <div class="d-flex gap-2 align-items-end">
                    <select id="saleProd" class="form-select"></select>
                    <input id="saleQty" type="number" class="form-control" min="1" value="1" />
                    <input id="saleDate" type="datetime-local" class="form-control" />
                    <button id="doSale" class="btn btn-success">Ghi b√°n</button>
                  </div>
                  <div class="text-muted small mt-2">Ghi b√°n s·∫Ω t·∫°o b·∫£n ghi xu·∫•t (sales) v√† gi·∫£m t·ªìn ngay l·∫≠p t·ª©c.</div>
                </div>
              </div>
            </div>
          </div>

        </div>
      </div>
    </div>
  </div>

  <script>
    const K = { cats:'book_cats', prods:'book_prods', receipts:'book_receipts', sales:'book_sales' };
    function ensure(){
      if (!localStorage.getItem(K.cats)) localStorage.setItem(K.cats, JSON.stringify([{id:'cat1',name:'Ti·ªÉu thuy·∫øt'},{id:'cat2',name:'K·ªπ thu·∫≠t & CNTT'},{id:'cat3',name:'Thi·∫øu nhi'}]));
      if (!localStorage.getItem(K.prods)) localStorage.setItem(K.prods, JSON.stringify([
        { id:'p1', title:'S√°ch Ti·ªÉu thuy·∫øt A', categoryId:'cat1', cost:120000, stock:10, threshold:5, initialStock:10, productProfit:null },
        { id:'p2', title:'L·∫≠p tr√¨nh JS', categoryId:'cat2', cost:220000, stock:5, threshold:3, initialStock:5, productProfit:null },
        { id:'p3', title:'Truy·ªán Thi·∫øu Nhi B', categoryId:'cat3', cost:80000, stock:15, threshold:6, initialStock:15, productProfit:null }
      ]));
      if (!localStorage.getItem(K.receipts)) localStorage.setItem(K.receipts, JSON.stringify([]));
      if (!localStorage.getItem(K.sales)) localStorage.setItem(K.sales, JSON.stringify([]));
    }
    ensure();

    const $ = s => document.querySelector(s);
    const $$ = s => Array.from(document.querySelectorAll(s));
  const prodSelect = $('#prodSelect'), atDate = $('#atDate'), computeAt = $('#computeAt'), stockAtResult = $('#stockAtResult');
  const catAtSelect = $('#catAtSelect'), catAtDate = $('#catAtDate'), catAtCompute = $('#catAtCompute'), catAtResult = $('#catAtResult');
  const lowStockList = $('#lowStockList'), refreshLow = $('#refreshLow');
  const histProd = $('#histProd'), fromDate = $('#fromDate'), toDate = $('#toDate'), getHist = $('#getHist'), histResult = $('#histResult');
  const catHistSelect = $('#catHistSelect'), catFromDate = $('#catFromDate'), catToDate = $('#catToDate'), catGet = $('#catGet'), catHistResult = $('#catHistResult');
    const saleProd = $('#saleProd'), saleQty = $('#saleQty'), saleDate = $('#saleDate'), doSale = $('#doSale');
    const btnRefresh = $('#btnRefresh');

    function read(k){ return JSON.parse(localStorage.getItem(k) || 'null'); }
    function write(k,v){ localStorage.setItem(k, JSON.stringify(v)); }

    function loadProductSelectors(){
      const prods = read(K.prods) || [];
      [prodSelect, histProd, saleProd].forEach(sel => {
        sel.innerHTML = '';
        prods.forEach(p => {
          const opt = document.createElement('option');
          opt.value = p.id; opt.textContent = `${p.title} (T·ªìn hi·ªán t·∫°i: ${p.stock})`;
          sel.appendChild(opt);
        });
      });
    }

    function loadCategorySelectors(){
      const cats = read(K.cats) || [];
      [catAtSelect, catHistSelect].forEach(sel => {
        if (!sel) return;
        sel.innerHTML = '';
        cats.forEach(c => {
          const o = document.createElement('option');
          o.value = c.id; o.textContent = c.name; sel.appendChild(o);
        });
      });
    }

    function computeStockAt(productId, isoDate) {
      const prods = read(K.prods) || [];
      const receipts = read(K.receipts) || [];
      const sales = read(K.sales) || [];
      const product = prods.find(p=>p.id===productId);
      if (!product) return null;
      const at = new Date(isoDate);
      let stock = Number(product.initialStock || 0);
      receipts.forEach(r=>{
        const rDate = new Date(r.date);
        if (rDate <= at && r.status === 'completed') {
          r.lines.forEach(li=> { if (li.productId === productId) stock += Number(li.qty||0); });
        }
      });
      sales.forEach(s=> {
        const sDate = new Date(s.date);
        if (sDate <= at && s.productId === productId) stock -= Number(s.qty||0);
      });
      return stock;
    }

    computeAt.onclick = () => {
      const pid = prodSelect.value;
      const dt = atDate.value ? new Date(atDate.value).toISOString() : new Date().toISOString();
      const stock = computeStockAt(pid, dt);
      const p = (read(K.prods) || []).find(x=>x.id===pid);
      stockAtResult.innerHTML = `<strong>${p.title}</strong> t·ªìn v√†o <em>${new Date(dt).toLocaleString()}</em>: <span class="fs-5">${stock}</span>`;
    };

    // Category stock at a time
    function computeCategoryStockAt(catId, isoDate){
      const prods = read(K.prods) || [];
      const list = prods.filter(p=>p.categoryId===catId);
      if (list.length === 0) return { rows: [], total: 0 };
      let total = 0;
      const rows = list.map(p => {
        const s = computeStockAt(p.id, isoDate);
        total += Number(s||0);
        return { title: p.title, stock: s };
      });
      return { rows, total };
    }
    catAtCompute.onclick = () => {
      const catId = catAtSelect.value;
      const dt = catAtDate.value ? new Date(catAtDate.value).toISOString() : new Date().toISOString();
      const cats = read(K.cats) || [];
      const cat = cats.find(c=>c.id===catId);
      const res = computeCategoryStockAt(catId, dt);
      let html = `<div class="mb-2">Lo·∫°i: <strong>${cat?cat.name:catId}</strong> ‚Äî Th·ªùi ƒëi·ªÉm: <em>${new Date(dt).toLocaleString()}</em></div>`;
      if (res.rows.length === 0) html += '<div class="text-muted">Kh√¥ng c√≥ s·∫£n ph·∫©m trong lo·∫°i n√†y.</div>';
      else {
        html += '<div class="table-responsive"><table class="table table-sm"><thead class="table-light"><tr><th>S·∫£n ph·∫©m</th><th>T·ªìn</th></tr></thead><tbody>';
        res.rows.forEach(r=>{ html += `<tr><td>${r.title}</td><td>${r.stock}</td></tr>`; });
        html += `</tbody><tfoot><tr><th>T·ªïng</th><th>${res.total}</th></tr></tfoot></table></div>`;
      }
      catAtResult.innerHTML = html;
    };

    function refreshLowStock(){
      const prods = read(K.prods) || [];
      lowStockList.innerHTML = '';
      const lows = prods.filter(p => Number(p.stock||0) <= (Number(p.threshold||5)));
      if (lows.length === 0) { lowStockList.innerHTML = '<div class="text-muted">Kh√¥ng c√≥ s·∫£n ph·∫©m s·∫Øp h·∫øt.</div>'; return; }
      const ul = document.createElement('ul');
      lows.forEach(p=>{
        const li = document.createElement('li');
        li.innerHTML = `<strong class="low">${p.title}</strong> ‚Äî T·ªìn: ${p.stock} (Ng∆∞·ª°ng: ${p.threshold})`;
        ul.appendChild(li);
      });
      lowStockList.appendChild(ul);
    }

    function getHistory(productId, fromIso, toIso){
      const receipts = read(K.receipts) || [];
      const sales = read(K.sales) || [];
      const from = new Date(fromIso), to = new Date(toIso);
      const recs = [];
      receipts.forEach(r=>{
        const d = new Date(r.date);
        if (d >= from && d <= to && r.status === 'completed') {
          r.lines.forEach(li=> { if (li.productId === productId) recs.push({ type:'in', date:r.date, qty:li.qty, price:li.price, ref:r.id }); });
        }
      });
      sales.forEach(s=>{
        const d = new Date(s.date);
        if (d >= from && d <= to && s.productId === productId) recs.push({ type:'out', date:s.date, qty:s.qty, ref:s.id, note:s.note||'' });
      });
      recs.sort((a,b)=> new Date(a.date) - new Date(b.date));
      return recs;
    }

    getHist.onclick = () => {
      const pid = histProd.value;
      const f = fromDate.value ? new Date(fromDate.value).toISOString() : new Date('1970-01-01').toISOString();
      const t = toDate.value ? new Date(toDate.value+'T23:59:59').toISOString() : new Date().toISOString();
      const recs = getHistory(pid, f, t);
      const p = (read(K.prods) || []).find(x=>x.id===pid);
      if (!p) return;
      let html = `<h6>L·ªãch s·ª≠ ${p.title} t·ª´ ${new Date(f).toLocaleString()} ƒë·∫øn ${new Date(t).toLocaleString()}</h6>`;
      if (recs.length === 0) html += '<div class="text-muted">Kh√¥ng c√≥ giao d·ªãch trong kho·∫£ng th·ªùi gian n√†y.</div>';
      else {
        html += `<div class="table-responsive"><table class="table table-sm"><thead class="table-light"><tr><th>Ng√†y</th><th>Lo·∫°i</th><th>SL</th><th>Tham chi·∫øu</th><th>Ghi ch√∫ / Gi√°</th></tr></thead><tbody>`;
        recs.forEach(r=>{
          html += `<tr>
            <td>${new Date(r.date).toLocaleString()}</td>
            <td>${r.type==='in' ? 'Nh·∫≠p' : 'Xu·∫•t'}</td>
            <td>${r.qty}</td>
            <td>${r.ref}</td>
            <td>${r.type==='in' ? (r.price + ' VND') : (r.note||'')}</td>
          </tr>`;
        });
        html += `</tbody></table></div>`;
        const totalIn = recs.filter(r=>r.type==='in').reduce((s,r)=>s + Number(r.qty||0),0);
        const totalOut = recs.filter(r=>r.type==='out').reduce((s,r)=>s + Number(r.qty||0),0);
        const beginStock = computeStockAt(pid, f);
        const endStock = computeStockAt(pid, t);
        html += `<div class="text-muted">T·ªïng nh·∫≠p: ${totalIn} ‚Äî T·ªïng xu·∫•t: ${totalOut} ‚Äî Ch√™nh: ${totalIn - totalOut}</div>`;
        html += `<div class="text-muted">T·ªìn ƒë·∫ßu k·ª≥: ${beginStock} ‚Äî T·ªìn cu·ªëi k·ª≥: ${endStock}</div>`;
      }
      histResult.innerHTML = html;
    };

    // Category aggregation over a date range
    function aggregateCategory(catId, fromIso, toIso){
      const prods = read(K.prods) || [];
      const receipts = read(K.receipts) || [];
      const sales = read(K.sales) || [];
      const from = new Date(fromIso), to = new Date(toIso);
      const list = prods.filter(p=>p.categoryId===catId);
      const rows = [];
      let tIn = 0, tOut = 0;
      list.forEach(p => {
        let inQty = 0, outQty = 0;
        receipts.forEach(r=>{
          const d = new Date(r.date);
          if (d >= from && d <= to && r.status==='completed'){
            r.lines.forEach(li=>{ if (li.productId===p.id) inQty += Number(li.qty||0); });
          }
        });
        sales.forEach(s=>{
          const d = new Date(s.date);
          if (d >= from && d <= to && s.productId===p.id) outQty += Number(s.qty||0);
        });
        const endStock = computeStockAt(p.id, toIso);
        rows.push({ title:p.title, inQty, outQty, delta: inQty - outQty, endStock });
        tIn += inQty; tOut += outQty;
      });
      return { rows, totalIn: tIn, totalOut: tOut };
    }
    catGet.onclick = () => {
      const catId = catHistSelect.value;
      const f = catFromDate.value ? new Date(catFromDate.value).toISOString() : new Date('1970-01-01').toISOString();
      const t = catToDate.value ? new Date(catToDate.value+'T23:59:59').toISOString() : new Date().toISOString();
      const cats = read(K.cats) || [];
      const cat = cats.find(c=>c.id===catId);
      const res = aggregateCategory(catId, f, t);
      let html = `<div class="mb-2">Lo·∫°i: <strong>${cat?cat.name:catId}</strong> ‚Äî T·ª´ ${new Date(f).toLocaleString()} ƒë·∫øn ${new Date(t).toLocaleString()}</div>`;
      if (res.rows.length === 0) html += '<div class="text-muted">Kh√¥ng c√≥ s·∫£n ph·∫©m thu·ªôc lo·∫°i n√†y.</div>';
      else {
        html += '<div class="table-responsive"><table class="table table-sm"><thead class="table-light"><tr><th>S·∫£n ph·∫©m</th><th>Nh·∫≠p</th><th>Xu·∫•t</th><th>Ch√™nh</th><th>T·ªìn cu·ªëi k·ª≥</th></tr></thead><tbody>';
        res.rows.forEach(r=>{ html += `<tr><td>${r.title}</td><td>${r.inQty}</td><td>${r.outQty}</td><td>${r.delta}</td><td>${r.endStock}</td></tr>`; });
        const totalDelta = res.totalIn - res.totalOut;
        html += `</tbody><tfoot><tr><th>T·ªïng</th><th>${res.totalIn}</th><th>${res.totalOut}</th><th>${totalDelta}</th><th>-</th></tr></tfoot></table></div>`;
      }
      catHistResult.innerHTML = html;
    };

    doSale.onclick = () => {
      const pid = saleProd.value;
      const qty = Math.max(1, Math.floor(Number(saleQty.value) || 1));
      const dateIso = saleDate.value ? new Date(saleDate.value).toISOString() : new Date().toISOString();
      if (!pid || qty <= 0) return alert('Ch·ªçn s·∫£n ph·∫©m v√† s·ªë l∆∞·ª£ng >=1.');
      const prods = read(K.prods) || [];
      const p = prods.find(x=>x.id===pid);
      if (!p) return alert('S·∫£n ph·∫©m kh√¥ng t·ªìn t·∫°i.');
      if (p.stock < qty) {
        if (!confirm(`T·ªìn hi·ªán t·∫°i (${p.stock}) nh·ªè h∆°n s·ªë b√°n (${qty}). Ti·∫øp t·ª•c?`)) return;
      }
      const sales = read(K.sales) || [];
      const id = 'S' + Date.now();
      const srec = { id, productId: pid, qty, date: dateIso, note: 'B√°n m√¥ ph·ªèng' };
      sales.unshift(srec);
      write(K.sales, sales);
      p.stock = Number(p.stock || 0) - qty;
      write(K.prods, prods);
      loadProductSelectors();
      refreshLowStock();
      alert('ƒê√£ ghi b√°n v√† gi·∫£m t·ªìn.');
    };

  btnRefresh.onclick = () => { ensure(); loadProductSelectors(); loadCategorySelectors(); refreshLowStock(); alert('L√†m m·ªõi xong'); };

    function init(){
      loadProductSelectors();
      loadCategorySelectors();
      atDate.value = new Date().toISOString().slice(0,16);
      if (catAtDate) catAtDate.value = new Date().toISOString().slice(0,16);
      saleDate.value = new Date().toISOString().slice(0,16);
      refreshLowStock();
    }
    init();
  </script>
</body>
</html>